name: "CF16 - Bulk Create Pages Under Parent"
description: "Verify create_pages creates multiple pages under specified parent page ID"

toolkits:
  - id: ${CONFLUENCE_TOOLKIT_ID}
    name: ${CONFLUENCE_TOOLKIT_NAME}

state:
  space:
    type: str
    value: "AT"
  pages_info:
    type: str
    value: '[{"TC_16_Child_A": "<h1>Child A</h1>"}, {"TC_16_Child_B": "<p>Child B</p>"}]'
  status:
    type: str
    value: "current"
  parent_id:
    type: str
    value: "104038676"
  create_result:
    type: str
  delete_result_a:
    type: str
  delete_result_b:
    type: str
  test_results:
    type: dict

entry_point: invoke_create_pages

nodes:
  - id: invoke_create_pages
    type: toolkit
    tool: create_pages
    toolkit_name: ${CONFLUENCE_TOOLKIT_NAME}
    input:
      - space
      - pages_info
      - status
      - parent_id
    input_mapping:
      space:
        type: variable
        value: space
      pages_info:
        type: variable
        value: pages_info
      status:
        type: variable
        value: status
      parent_id:
        type: variable
        value: parent_id
    output:
      - create_result
    structured_output: true
    transition: cleanup_delete_child_a

  - id: cleanup_delete_child_a
    type: toolkit
    tool: delete_page
    toolkit_name: ${CONFLUENCE_TOOLKIT_NAME}
    input: []
    input_mapping:
      page_title:
        type: fixed
        value: "TC_16_Child_A"
    output:
      - delete_result_a
    structured_output: true
    transition: cleanup_delete_child_b

  - id: cleanup_delete_child_b
    type: toolkit
    tool: delete_page
    toolkit_name: ${CONFLUENCE_TOOLKIT_NAME}
    input: []
    input_mapping:
      page_title:
        type: fixed
        value: "TC_16_Child_B"
    output:
      - delete_result_b
    structured_output: true
    transition: process_results

  - id: process_results
    type: llm
    model: gpt-4o
    input:
      - create_result
      - delete_result_a
      - delete_result_b
      - pages_info
      - parent_id
    input_mapping:
      system:
        type: fixed
        value: "You are a quality assurance validator."
      task:
        type: fstring
        value: |
          Analyze the complete workflow results.
          
          Create Result: {create_result}
          Delete Result A: {delete_result_a}
          Delete Result B: {delete_result_b}
          Pages Info: {pages_info}
          Parent ID: {parent_id}
          
          Perform the following checks:
          
          1. Confirm the tool executed successfully (the result is not empty or null).
          2. Verify the output contains success messages for each page.
          3. Check if messages include "was created under the parent page" text.
          4. Validate each message has page details (title, id, space key, author, link).
          5. Count the number of pages created (should be 2).
          6. Confirm both child pages were deleted successfully in cleanup.
          
          Return a JSON object named test_results with the following structure:
          
          {{
            "test_passed": boolean (true if all pages created under parent successfully AND deleted),
            "tool_executed": boolean (true if tool ran without errors),
            "has_parent_reference": boolean (true if messages mention parent page),
            "pages_created_count": integer (number of pages created),
            "all_have_details": boolean (true if all pages have detail keys),
            "expected_count": 2,
            "pages_deleted": boolean (true if both pages deleted in cleanup),
            "failed_checks": [string] // list of failed assertions
          }}
          
          Return **EXACTLY** **NONNEGOTIATABLE** only the `test_results` JSON object.
          Do not use markdown ```json when returning the json.
          Do not include any explanations, summaries, or additional text.
      chat_history:
        type: fixed
        value: []
    output:
      - test_results
    structured_output_dict:
        test_results: "dict"
    transition: END
        value: space
      pages_info:
        type: variable
        value: pages_info
      status:
        type: variable
        value: status
      parent_id:
        type: variable
        value: parent_id
    output:
      - tool_result
    structured_output: true
    transition: process_results

  - id: process_results
    type: llm
    model: gpt-4o
    input:
      - tool_result
      - pages_info
      - parent_id
    input_mapping:
      system:
        type: fixed
        value: "You are a quality assurance validator."
      task:
        type: fstring
        value: |
          Analyze the output from the 'create_pages' tool.
          
          Tool Result: {tool_result}
          Pages Info: {pages_info}
          Parent ID: {parent_id}
          
          Perform the following checks:
          
          1. Confirm the tool executed successfully (the result is not empty or null).
          2. Verify the output contains success messages for each page.
          3. Check if messages include "was created under the parent page" text.
          4. Validate each message has page details (title, id, space key, author, link).
          5. Count the number of pages created (should be 2).
          
          Return a JSON object named test_results with the following structure:
          
          {{
            "test_passed": boolean (true if all pages created under parent successfully),
            "tool_executed": boolean (true if tool ran without errors),
            "has_parent_reference": boolean (true if messages mention parent page),
            "pages_created_count": integer (number of pages created),
            "all_have_details": boolean (true if all pages have detail keys),
            "expected_count": 2,
            "failed_checks": [string] // list of failed assertions
          }}
          
          Return **EXACTLY** **NONNEGOTIATABLE** only the `test_results` JSON object.
          Do not use markdown ```json when returning the json.
          Do not include any explanations, summaries, or additional text.
      chat_history:
        type: fixed
        value: []
    output:
      - test_results
    structured_output_dict:
        test_results: "dict"
    transition: cleanup_delete_child_a

  - id: cleanup_delete_child_a
    type: toolkit
    tool: delete_page
    toolkit_name: ${CONFLUENCE_TOOLKIT_NAME}
    input: []
    input_mapping:
      page_title:
        type: fixed
        value: "TC_16_Child_A"
    output:
      - tool_result
    structured_output: true
    transition: cleanup_delete_child_b

  - id: cleanup_delete_child_b
    type: toolkit
    tool: delete_page
    toolkit_name: ${CONFLUENCE_TOOLKIT_NAME}
    input: []
    input_mapping:
      page_title:
        type: fixed
        value: "TC_16_Child_B"
    output:
      - tool_result
    structured_output: true
    transition: END
