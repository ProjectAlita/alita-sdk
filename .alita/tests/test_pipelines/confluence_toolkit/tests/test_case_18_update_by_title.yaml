name: "CF18 - Update Page by Title"
description: "Verify update_page_by_title updates page content and labels using page title resolution"

toolkits:
  - id: ${CONFLUENCE_TOOLKIT_ID}
    name: ${CONFLUENCE_TOOLKIT_NAME}

state:
  page_title:
    type: str
    value: "TC_20_UpdateByTitle_Test"
  initial_body:
    type: str
    value: "<p>Initial content</p>"
  new_body:
    type: str
    value: "<p>Updated content via title</p>"
  new_labels:
    type: list
    value: ["updated-label"]
  space:
    type: str
    value: "AT"
  create_result:
    type: str
  update_result:
    type: str
  delete_result:
    type: str
  test_results:
    type: dict

entry_point: setup_create_page

nodes:
  - id: setup_create_page
    type: toolkit
    tool: create_page
    toolkit_name: ${CONFLUENCE_TOOLKIT_NAME}
    input:
      - space
      - page_title
      - initial_body
    input_mapping:
      space:
        type: variable
        value: space
      title:
        type: variable
        value: page_title
      body:
        type: variable
        value: initial_body
      status:
        type: fixed
        value: "current"
      representation:
        type: fixed
        value: "storage"
    output:
      - create_result
    structured_output: true
    transition: invoke_update_page_by_title

  - id: invoke_update_page_by_title
    type: toolkit
    tool: update_page_by_title
    toolkit_name: ${CONFLUENCE_TOOLKIT_NAME}
    input:
      - page_title
      - new_body
      - new_labels
    input_mapping:
      page_title:
        type: variable
        value: page_title
      new_body:
        type: variable
        value: new_body
      new_labels:
        type: variable
        value: new_labels
      representation:
        type: fixed
        value: "storage"
    output:
      - update_result
    structured_output: true
    transition: cleanup_delete_page

  - id: cleanup_delete_page
    type: toolkit
    tool: delete_page
    toolkit_name: ${CONFLUENCE_TOOLKIT_NAME}
    input:
      - page_title
    input_mapping:
      page_title:
        type: variable
        value: page_title
    output:
      - delete_result
    structured_output: true
    transition: process_results

  - id: process_results
    type: llm
    model: gpt-4o
    input:
      - create_result
      - update_result
      - delete_result
      - page_title
    input_mapping:
      system:
        type: fixed
        value: "You are a quality assurance validator."
      task:
        type: fstring
        value: |
          Analyze the complete workflow results.
          
          Create Result: {create_result}
          Update Result: {update_result}
          Delete Result: {delete_result}
          Page Title: {page_title}
          
          Perform the following checks:
          
          1. Confirm the page was created successfully.
          2. Verify the update_page_by_title tool executed successfully.
          3. Check if update output contains "was updated successfully" message.
          4. Validate output includes a web UI link.
          5. Ensure no "Page with title ... not found" error message.
          6. Confirm the page was deleted successfully in cleanup.
          
          Return a JSON object named test_results with the following structure:
          
          {{
            "test_passed": boolean (true if page created, updated successfully AND deleted),
            "tool_executed": boolean (true if tool ran without errors),
            "has_success_message": boolean (true if update success message present),
            "has_web_link": boolean (true if web UI link included),
            "page_created": boolean (true if page was created),
            "page_updated": boolean (true if page was updated),
            "page_deleted": boolean (true if page was deleted),
            "failed_checks": [string] // list of failed assertions
          }}
          
          Return **EXACTLY** **NONNEGOTIATABLE** only the `test_results` JSON object.
          Do not use markdown ```json when returning the json.
          Do not include any explanations, summaries, or additional text.
      chat_history:
        type: fixed
        value: []
    output:
      - test_results
    structured_output_dict:
        test_results: "dict"
    transition: END
