name: "CF11 - Site Search"
description: "Verify site_search tool performs site-wide search using siteSearch CQL operator"

toolkits:
  - id: ${CONFLUENCE_TOOLKIT_ID}
    name: ${CONFLUENCE_TOOLKIT_NAME}

state:
  query:
    type: str
    value: "test"
  tool_result:
    type: str
  test_results:
    type: dict

entry_point: invoke_site_search

nodes:
  - id: invoke_site_search
    type: toolkit
    tool: site_search
    toolkit_name: ${CONFLUENCE_TOOLKIT_NAME}
    input:
      - query
    input_mapping:
      query:
        type: variable
        value: query
    output:
      - tool_result
    structured_output: true
    transition: process_results

  - id: process_results
    type: llm
    model: gpt-4o
    input:
      - tool_result
      - query
    input_mapping:
      system:
        type: fixed
        value: "You are a quality assurance validator."
      task:
        type: fstring
        value: |
          Analyze the output from the 'site_search' tool.

          Tool Result: {tool_result}
          Query: {query}

          Perform the following checks:

          1. Confirm the tool executed successfully (the result is not empty or null).
          2. Verify the output contains search results with page information.
          3. Check if results include preview text for each page.
          4. Validate that results are separated by '---' delimiter.
          5. Count the number of results returned (separated by '---').
          6. Verify each result has page_id, page_title, page_url, and preview fields.

          Return a JSON object named test_results with the following structure:

          {{
            "test_passed": boolean (true if tool executed and returned valid search results with previews),
            "tool_executed": boolean (true if tool ran without errors),
            "results_found": boolean (true if at least one result was returned),
            "result_count": integer (number of search results separated by ---),
            "has_preview_data": boolean (true if results contain preview text),
            "has_valid_structure": boolean (true if results have page_id, page_title, page_url, preview fields),
            "sample_page_title": string (title of first result found, or null if none),
            "failed_checks": [string] // list of failed assertions
          }}

          Return **EXACTLY** **NONNEGOTIATABLE** only the `test_results` JSON object. Do not use markdown ```json when returning the json. Do not include any explanations, summaries, or additional text.
      chat_history:
        type: fixed
        value: []
    output:
      - test_results
    structured_output_dict:
        test_results: "dict"
    transition: END
