# NEG_14: Invalid Repository Format
# Verifies that invalid repository format returns actionable error
# Expected: Clear error message about expected format "owner/repo"

name: "NEG14 - Invalid Repository Format"
description: "Verify toolkit returns actionable error for malformed repository name"

toolkits:
  - id: ${GITHUB_TOOLKIT_ID}
    name: ${GITHUB_TOOLKIT_NAME}

state:
  input:
    type: str
  messages:
    type: list
  invalid_repo:
    type: str
    value: "invalid-repo-without-slash"  # Missing owner/repo format
  tool_result:
    type: str
  test_results:
    type: dict

entry_point: invoke_get_issue_invalid_repo

nodes:
  - id: invoke_get_issue_invalid_repo
    type: toolkit
    tool: get_issue
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - invalid_repo
    input_mapping:
      issue_number:
        type: fixed
        value: 1
      repo_name:
        type: variable
        value: invalid_repo
    output:
      - tool_result
    structured_output: true
    transition: validate_error

  - id: validate_error
    type: code
    code:
      type: fixed
      value: |
        result = alita_state.get('tool_result')
        invalid_repo = alita_state.get('invalid_repo')
        result_str = str(result).lower() if result else ''

        # Error quality checks
        # Should indicate format issue
        has_format_error = any(term in result_str for term in [
            'invalid', 'format', 'owner/repo', 'slash', 'malformed',
            '404', 'not found'  # Also acceptable - GitHub returns 404 for bad format
        ])

        # Should reference repository
        references_repo = any(term in result_str for term in ['repo', 'repository'])

        # No raw tracebacks
        no_traceback = 'traceback' not in result_str

        # Not a success response
        not_success = 'number' not in result_str or 'error' in result_str or 'failed' in result_str

        test_passed = has_format_error and not_success and no_traceback

        test_results = {
            "test_passed": test_passed,
            "error_quality": {
                "indicates_format_error": has_format_error,
                "references_repository": references_repo,
                "no_raw_traceback": no_traceback,
                "not_success_response": not_success
            },
            "invalid_input": invalid_repo,
            "actual_response": result_str[:500],
            "improvement_needed": [] if test_passed else [
                "Missing format error indicator" if not has_format_error else None,
                "Does not reference repository" if not references_repo else None,
                "Contains raw traceback" if not no_traceback else None,
                "Returns success for invalid input" if not not_success else None
            ]
        }
        test_results["improvement_needed"] = [x for x in test_results["improvement_needed"] if x]
        test_results
    input:
      - tool_result
      - invalid_repo
    output:
      - messages
    structured_output: false
    transition: END
