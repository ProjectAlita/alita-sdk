# NEG_17: Invalid Branch Name Characters
# Verifies that invalid branch names return actionable errors
# Expected: Clear error message about invalid characters

name: "NEG17 - Invalid Branch Name"
description: "Verify create_branch returns actionable error for invalid branch names"

toolkits:
  - id: ${GITHUB_TOOLKIT_ID}
    name: ${GITHUB_TOOLKIT_NAME}

state:
  input:
    type: str
  messages:
    type: list
  space_result:
    type: str
  dots_result:
    type: str
  test_results:
    type: dict

entry_point: test_space_in_name

nodes:
  # Test branch name with spaces (invalid)
  - id: test_space_in_name
    type: toolkit
    tool: create_branch
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input: []
    input_mapping:
      branch_name:
        type: fixed
        value: "invalid branch name with spaces"
    output:
      - space_result
    structured_output: true
    transition: test_dots_in_name

  # Test branch name with consecutive dots (invalid per git)
  - id: test_dots_in_name
    type: toolkit
    tool: create_branch
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input: []
    input_mapping:
      branch_name:
        type: fixed
        value: "branch..with..dots"
    output:
      - dots_result
    structured_output: true
    transition: validate_errors

  - id: validate_errors
    type: code
    code:
      type: fixed
      value: |
        space_result = alita_state.get('space_result')
        dots_result = alita_state.get('dots_result')

        space_str = str(space_result).lower() if space_result else ''
        dots_str = str(dots_result).lower() if dots_result else ''

        # Check space in name handling
        space_has_error = any(term in space_str for term in ['invalid', 'error', 'failed', 'illegal', 'cannot'])
        space_no_traceback = 'traceback' not in space_str
        space_not_success = 'created' not in space_str or 'error' in space_str or 'failed' in space_str

        # Check dots handling
        dots_has_error = any(term in dots_str for term in ['invalid', 'error', 'failed', 'illegal', 'cannot'])
        dots_no_traceback = 'traceback' not in dots_str
        dots_not_success = 'created' not in dots_str or 'error' in dots_str or 'failed' in dots_str

        # At least one should fail (Git typically rejects these)
        test_passed = ((space_has_error or space_not_success) and space_no_traceback and
                       (dots_has_error or dots_not_success) and dots_no_traceback)

        test_results = {
            "test_passed": test_passed,
            "space_in_name_test": {
                "indicates_error": space_has_error,
                "no_traceback": space_no_traceback,
                "not_success": space_not_success,
                "response": space_str[:300]
            },
            "dots_in_name_test": {
                "indicates_error": dots_has_error,
                "no_traceback": dots_no_traceback,
                "not_success": dots_not_success,
                "response": dots_str[:300]
            }
        }
        test_results
    input:
      - space_result
      - dots_result
    output:
      - messages
    structured_output: false
    transition: END
