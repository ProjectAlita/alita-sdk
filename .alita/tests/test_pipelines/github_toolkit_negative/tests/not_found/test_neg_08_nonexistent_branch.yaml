# NEG_08: Get Non-Existent Branch
# Verifies that operations on non-existent branches return actionable errors
# Expected: Clear error message about branch not found

name: "NEG08 - Get Non-Existent Branch"
description: "Verify list_files returns actionable error for non-existent branch"

toolkits:
  - id: ${GITHUB_TOOLKIT_ID}
    name: ${GITHUB_TOOLKIT_NAME}

state:
  input:
    type: str
  messages:
    type: list
  branch_name:
    type: str
    value: "nonexistent-branch-xyz-12345"
  set_result:
    type: str
  list_result:
    type: str
  test_results:
    type: dict

entry_point: set_invalid_branch

nodes:
  # First try to set an invalid branch
  - id: set_invalid_branch
    type: toolkit
    tool: set_active_branch
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - branch_name
    input_mapping:
      branch_name:
        type: variable
        value: branch_name
    output:
      - set_result
    structured_output: true
    transition: try_list_files

  # Then try to list files (should fail due to invalid branch)
  - id: try_list_files
    type: toolkit
    tool: list_files_in_bot_branch
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input: []
    input_mapping: {}
    output:
      - list_result
    structured_output: true
    transition: validate_error

  - id: validate_error
    type: code
    code:
      type: fixed
      value: |
        set_result = alita_state.get('set_result')
        list_result = alita_state.get('list_result')
        branch_name = alita_state.get('branch_name')

        # Check both results for error indicators
        set_str = str(set_result).lower() if set_result else ''
        list_str = str(list_result).lower() if list_result else ''
        combined = set_str + ' ' + list_str

        # Error quality checks
        # 1. Should indicate branch not found or reference error
        has_not_found = any(term in combined for term in ['not found', '404', 'does not exist', 'no such', 'branch', 'ref'])

        # 2. Should reference branch
        references_branch = 'branch' in combined or 'ref' in combined

        # 3. Should NOT contain raw tracebacks
        no_traceback = 'traceback' not in combined

        # 4. At least one operation should indicate failure
        indicates_failure = any(term in combined for term in ['error', 'failed', 'not found', 'invalid', '404'])

        # Test passes if error is properly communicated
        test_passed = indicates_failure and no_traceback

        test_results = {
            "test_passed": test_passed,
            "error_quality": {
                "indicates_not_found": has_not_found,
                "references_branch": references_branch,
                "no_raw_traceback": no_traceback,
                "indicates_failure": indicates_failure
            },
            "requested_branch": branch_name,
            "set_branch_response": set_str[:300],
            "list_files_response": list_str[:300],
            "improvement_needed": [] if test_passed else [
                "Missing failure indicator" if not indicates_failure else None,
                "Does not reference branch" if not references_branch else None,
                "Contains raw traceback" if not no_traceback else None
            ]
        }
        test_results["improvement_needed"] = [x for x in test_results["improvement_needed"] if x]
        test_results
    input:
      - set_result
      - list_result
      - branch_name
    output:
      - messages
    structured_output: false
    transition: END
