name: "JR21 - Get Comments with Image Descriptions (Happy Path)"
priority: Critical
description: |
  Verify `get_comments_with_image_descriptions` tool retrieves comments with image processing.

  Objective: Ensure tool can get comments and process images in them.

  Expected Behavior:
  - Tool executes successfully without errors.
  - Returns comments with image descriptions.

toolkits:
  - id: ${JIRA_TOOLKIT_ID}
    name: ${JIRA_TOOLKIT_NAME}

state:
  issue_key:
    type: str
    value: ${JIRA_TEST_ISSUE_2}
  tool_result:
    type: str
  test_results:
    type: dict

entry_point: invoke_get_comments_with_images

nodes:
  - id: invoke_get_comments_with_images
    type: toolkit
    tool: get_comments_with_image_descriptions
    toolkit_name: ${JIRA_TOOLKIT_NAME}
    input:
      - issue_key
    input_mapping:
      jira_issue_key:
        type: variable
        value: issue_key
    output:
      - tool_result
    structured_output: true
    transition: process_results

  - id: process_results
    type: llm
    model: ${DEFAULT_LLM_MODEL}
    input:
      - tool_result
    input_mapping:
      system:
        type: fixed
        value: "You are a quality assurance validator."
      task:
        type: fstring
        value: |
          Analyze the output from the 'get_comments_with_image_descriptions' tool.

          Tool Result: {tool_result}

          Perform the following checks:
          1. Confirm the tool executed successfully (result is not empty or null).
          2. Result should contain comments with text content.
          3. For images in comments, verify descriptions are meaningful:
             - meaningful descriptions contain actual content analysis (not just error messages)
             - expected warning patterns that indicate acceptable behavior (check if message contains these keywords):
               * "identify" + "image" + "format" - PIL cannot read the format
               * "loading image" or "load" + "error" - file corruption or unsupported format
               * "converting image" or "convert" + "error" - image processing failed
               * "attachment not found" or "not found" - image reference doesn't exist
               * "download failed" or "download" + "error" - network or authentication issue
               * "image processing error" or "processing" + "error" - LLM temporarily unavailable
               * "no content url" or "content" + "url" - attachment has no downloadable content
             - unacceptable patterns indicating system failure:
               * "llm not available" - configuration issue
               * stack traces or unexpected python exceptions
          4. If comments exist without images, the tool should still succeed.
          5. If images have descriptions, they should describe the actual image content.

          Look for keywords and patterns, not exact message matches.
          Determine if warnings are expected processing limitations (acceptable) or system failures (test fails).
          Expected warnings indicate proper error handling and are acceptable.

          Return a JSON object named test_results with the following structure:

          {{
            "test_passed": boolean (true if descriptions are meaningful or tool handles missing images correctly),
            "summary": "brief description of outcome",
            "error": "error details if failed, null if passed"
          }}

          Return **ONLY** the JSON object. No markdown, no additional text.
      chat_history:
        type: fixed
        value: []
    output:
      - test_results
    structured_output_dict:
      test_results: "dict"
    transition: END
