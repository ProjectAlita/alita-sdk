suite_name: jira
description: Test suite for JIRA toolkit

# Setup stage - creates all artifacts and credentials needed by tests
setup:
  # Step 1: Setup JIRA Configuration (credentials)
  - name: Setup JIRA Configuration
    type: configuration
    config:
      config_type: jira
      alita_title: ${JIRA_SECRET_NAME:jira}
      data:
        base_url: ${JIRA_BASE_URL}
        username: ${JIRA_USERNAME}
        api_key: ${JIRA_API_KEY}

  # Step 2: Create JIRA Toolkit Instance
  - name: Create JIRA Toolkit
    type: toolkit
    action: create_or_update
    config:
      config_file: ../../configs/jira-config.json
      toolkit_type: jira
      overrides:
        jira_configuration:
          private: true
          alita_title: ${JIRA_SECRET_NAME:jira}
      toolkit_name: ${JIRA_TOOLKIT_NAME:testing}
    save_to_env:
      - key: JIRA_TOOLKIT_ID
        value: $.id
      - key: JIRA_TOOLKIT_NAME
        value: $.name

  # Step 3: Get Test Issue (for test isolation)
  - name: Get or Create Test Issue
    type: toolkit_invoke
    config:
      toolkit_id: ${JIRA_TOOLKIT_ID}
      tool_name: search_using_jql
      tool_params:
        jql: 'project = ${JIRA_PROJECT:TEST} ORDER BY created DESC'
    continue_on_error: true
    save_to_env:
      - key: JIRA_TEST_ISSUE
        value: $.result.issues[0].key
        default: ${JIRA_PROJECT:TEST}-1

  # Step 4: Get second test issue for linking tests
  - name: Get Second Test Issue
    type: toolkit_invoke
    config:
      toolkit_id: ${JIRA_TOOLKIT_ID}
      tool_name: search_using_jql
      tool_params:
        jql: 'project = ${JIRA_PROJECT:TEST} ORDER BY updated DESC'
    continue_on_error: true
    save_to_env:
      - key: JIRA_TEST_ISSUE_2
        value: $.result.issues[1].key
        default: ${JIRA_PROJECT:TEST}-2

# Test execution configuration
execution:
  test_directory: tests
  test_pattern: "test_case_*.yaml"
  parallel: false
  
  # Variables to substitute in test YAML files
  substitutions:
    JIRA_TOOLKIT_ID: ${JIRA_TOOLKIT_ID}
    JIRA_TOOLKIT_NAME: ${JIRA_TOOLKIT_NAME}
    JIRA_PROJECT: ${JIRA_PROJECT}
    JIRA_TEST_ISSUE: ${JIRA_TEST_ISSUE}
    JIRA_TEST_ISSUE_2: ${JIRA_TEST_ISSUE_2}
    TIMESTAMP: ${TIMESTAMP}
    DEFAULT_LLM_MODEL: ${DEFAULT_LLM_MODEL:gpt-4o-2024-11-20}

# Cleanup stage - remove created artifacts
cleanup:
  - name: Delete Test Toolkit
    type: toolkit
    action: delete
    config:
      toolkit_id: ${JIRA_TOOLKIT_ID}
