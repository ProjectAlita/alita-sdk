# Artifact Toolkit Test Suite Configuration
# This file defines setup, execution, and cleanup for the test suite
#
# This configuration is toolkit-agnostic - all specificity comes from
# the config values, not hardcoded handlers in setup.py/cleanup.py

name: artifact_toolkit
description: Artifact toolkit integration tests

# Environment variable mappings
# These map .env variables to config values used in setup
env_mapping:
  bucket: ${ARTIFACT_BUCKET:artifact-test-bucket}
  toolkit_name: ${ARTIFACT_TOOLKIT_NAME:artifact-testing}
  confluence_space: ${CONFLUENCE_SPACE:AT}
  confluence_base_url: ${CONFLUENCE_BASE_URL:https://epamelitea.atlassian.net/}
  confluence_api_key: ${CONFLUENCE_API_KEY}
  confluence_username: ${CONFLUENCE_USERNAME}

# Setup steps executed before running tests
# Steps are executed in order; if a step fails, setup stops
setup:
  # Step 1: Ensure Confluence credentials configuration exists
  - name: Setup Confluence Configuration
    type: configuration
    config:
      config_type: confluence
      alita_title: ${CONFLUENCE_SECRET_NAME:confluence}
      data:
        api_key: ${CONFLUENCE_API_KEY}
        base_url: ${CONFLUENCE_BASE_URL:https://epamelitea.atlassian.net/}
        username: ${CONFLUENCE_USERNAME}

  # Step 2: Create or update the Confluence toolkit on the platform
  - name: Create Confluence Toolkit
    type: toolkit
    action: create_or_update
    config:
      config_file: ../../configs/confluence-config.json
      toolkit_type: confluence
      overrides:
        confluence_configuration:
          private: true
          alita_title: ${CONFLUENCE_SECRET_NAME:confluence}
        space: ${CONFLUENCE_SPACE:AT}
        cloud: true
      toolkit_name: ${CONFLUENCE_TOOLKIT_NAME:confluence-testing}
    save_to_env:
      - key: CONFLUENCE_TOOLKIT_ID
        value: $.id
      - key: CONFLUENCE_TOOLKIT_NAME
        value: $.name

  # Step 3: Create Artifact Toolkit on the platform
  - name: Create Artifact Toolkit
    type: toolkit
    action: create_or_update
    config:
      toolkit_type: artifact
      toolkit_name: ${ARTIFACT_TOOLKIT_NAME:artifact-testing}
      settings:
        bucket: ${ARTIFACT_BUCKET:artifact-test-bucket}
    save_to_env:
      - key: ARTIFACT_TOOLKIT_ID
        value: $.id
      - key: ARTIFACT_TOOLKIT_NAME
        value: $.name
      - key: TEST_BUCKET
        value: artifact-test-bucket

  # Step 4: Create test file artifact for Confluence tests
  - name: Create Test File Artifact
    type: toolkit_invoke
    config:
      toolkit_id: ${ARTIFACT_TOOLKIT_ID}
      tool_name: createFile
      tool_params:
        filename: test_upload.txt
        filedata: |
          This is a test file for Confluence file upload testing.
          
          Created at ${TIMESTAMP}
          Test Suite: Artifact Toolkit
          
          This file is used to test the add_file_to_page tool.
    save_to_env:
      - key: TEST_ARTIFACT_ID
        value: $.result.filepath
        default: "/artifact-test-bucket/test_upload.txt"

# Composable pipelines - seeded first, used by hooks and other pipelines
# These are reusable pipeline components that can be invoked conditionally
composable_pipelines: []

# Test execution configuration
execution:
  # Order of test execution (by file pattern or explicit list)
  # Tests are located in tests/ subdirectory
  test_directory: tests
  order:
    - test_case_01_*.yaml  # ART01 - Create New Bucket
    - test_case_02_*.yaml  # ART02 - Create File
    - test_case_03_*.yaml  # ART03 - Create File Error Handling
    - test_case_04_*.yaml  # ART04 - List Files
    - test_case_05_*.yaml  # ART05 - Read File
    - test_case_06_*.yaml  # ART06 - Read File Chunk
    - test_case_07_*.yaml  # ART07 - Search File
    - test_case_08_*.yaml  # ART08 - Edit File
    - test_case_09_*.yaml  # ART09 - Append Data
    - test_case_10_*.yaml  # ART10 - Overwrite Data
    - test_case_11_*.yaml  # ART11 - Delete File
    - test_case_12_*.yaml  # ART12 - Read Multiple Files
    - test_case_13_*.yaml  # ART13 - Get File Type
    - test_case_25_*.yaml  # ART14 - Confluence Add File
    - test_case_26_*.yaml  # ART15 - Confluence Add File Validation

  # Variables to substitute in test YAML files
  substitutions:
    ARTIFACT_TOOLKIT_ID: ${ARTIFACT_TOOLKIT_ID}
    ARTIFACT_TOOLKIT_NAME: ${ARTIFACT_TOOLKIT_NAME}
    CONFLUENCE_TOOLKIT_ID: ${CONFLUENCE_TOOLKIT_ID}
    CONFLUENCE_TOOLKIT_NAME: ${CONFLUENCE_TOOLKIT_NAME}
    TIMESTAMP: ${TIMESTAMP}
    TEST_BUCKET: ${TEST_BUCKET}
    TEST_ARTIFACT_ID: ${TEST_ARTIFACT_ID}

  # Execution settings
  settings:
    timeout: 120
    parallel: 1  # Sequential for dependent tests
    stop_on_failure: false

# Cleanup steps executed after tests complete
# Steps are executed in order; failures are logged but don't stop cleanup
cleanup:
  # Step 1: Delete seeded pipelines
  - name: Delete Test Pipelines
    type: pipeline
    config:
      pattern: "ART*"  # All Artifact test pipelines
    continue_on_error: true

  # Step 2: Delete the artifact toolkit
  - name: Delete Artifact Toolkit
    type: toolkit
    config:
      toolkit_id: ${ARTIFACT_TOOLKIT_ID}
    enabled: true
    continue_on_error: true

  # Step 3: Delete the confluence toolkit
  - name: Delete Confluence Toolkit
    type: toolkit
    config:
      toolkit_id: ${CONFLUENCE_TOOLKIT_ID}
    enabled: true
    continue_on_error: true

# Hooks for custom actions
hooks:
  # Run before any setup steps
  pre_setup: []

  # Run after all setup steps complete
  post_setup: []

  # Run after each test
  post_test: []

  # Run before cleanup starts
  pre_cleanup: []

  # Run after cleanup completes
  post_cleanup: []
