name: "BB16 - append_file: Append content to existing file"
description: |
  Verify the Bitbucket 'append_file' tool adds content to the end of a file.

  Objective: Test content appending functionality

  Expected Behavior:
  - Initial file is created with content
  - Append operation adds new content at the end
  - Original content is preserved
  - Content order is maintained

toolkits:
  - id: ${BITBUCKET_TOOLKIT_ID}
    name: ${BITBUCKET_TOOLKIT_NAME}

state:
  test_file_path:
    type: str
    value: test-files/bb16-append-test.log
  initial_content:
    type: str
    value: |
      === Log File BB16 ===
      [2024-01-01 10:00:00] Test started
      [2024-01-01 10:00:01] Initial entry
  append_content:
    type: str
    value: |
      [2024-01-01 10:00:02] Appended entry 1
      [2024-01-01 10:00:03] Appended entry 2
      [2024-01-01 10:00:04] Test completed
  expected_combined_indicators:
    type: list
    value: ["Test started", "Initial entry", "Appended entry 1", "Test completed"]
  error_indicators:
    type: list
    value: ["error", "failed", "exception", "not found"]
  create_result:
    type: str
  append_result:
    type: str
  final_content:
    type: str
  cleanup_result:
    type: str
  test_results:
    type: dict

entry_point: create_initial_file
nodes:
  - id: create_initial_file
    type: toolkit
    input:
      - test_file_path
      - initial_content
    input_mapping:
      file_path:
        type: variable
        value: test_file_path
      file_contents:
        type: variable
        value: initial_content
      branch:
        type: variable
        value: ACTIVE_BRANCH
    output:
      - create_result
    structured_output: true
    tool: create_file
    toolkit_name: ${BITBUCKET_TOOLKIT_NAME}
    transition: append_content_to_file

  - id: append_content_to_file
    type: toolkit
    input:
      - test_file_path
      - append_content
    input_mapping:
      file_path:
        type: variable
        value: test_file_path
      content:
        type: variable
        value: append_content
      branch:
        type: variable
        value: ACTIVE_BRANCH
    output:
      - append_result
    structured_output: true
    tool: append_file
    toolkit_name: ${BITBUCKET_TOOLKIT_NAME}
    transition: verify_appended_content

  - id: verify_appended_content
    type: toolkit
    input:
      - test_file_path
    input_mapping:
      file_path:
        type: variable
        value: test_file_path
      branch:
        type: variable
        value: ACTIVE_BRANCH
    output:
      - final_content
    structured_output: true
    tool: read_file
    toolkit_name: ${BITBUCKET_TOOLKIT_NAME}
    transition: cleanup_file

  - id: cleanup_file
    type: toolkit
    input:
      - test_file_path
    input_mapping:
      file_path:
        type: variable
        value: test_file_path
      branch:
        type: variable
        value: ACTIVE_BRANCH
    output:
      - cleanup_result
    structured_output: true
    tool: delete_file
    toolkit_name: ${BITBUCKET_TOOLKIT_NAME}
    transition: validate_results

  - id: validate_results
    type: llm
    input:
      - create_result
      - append_result
      - final_content
      - initial_content
      - append_content
      - expected_combined_indicators
      - error_indicators
    input_mapping:
      chat_history:
        type: fixed
        value: []
      system:
        type: fixed
        value: You are a strict quality assurance validator. Only return valid JSON.
      task:
        type: fstring
        value: |
          Analyze the output from 'append_file' tool execution.

          Create Result: {create_result}
          Append Result: {append_result}
          Final Content: {final_content}
          Initial Content: {initial_content}
          Appended Content: {append_content}
          Expected Combined Indicators: {expected_combined_indicators}
          Error Indicators: {error_indicators}

          This is a POSITIVE test - we expect successful content appending.

          Validation Criteria (ALL must pass for test_passed=true):
          1. file_created: Initial file was created successfully
          2. no_errors: No error indicators in any output
          3. append_succeeded: Append operation completed without errors
          4. original_content_preserved: Final content contains all initial content
          5. appended_content_present: Final content contains all appended content
          6. chronological_order: Content appears in chronological order (initial before appended)
          7. all_indicators_present: All expected combined indicators are in final content

          Return JSON test_results:
          {{
            "test_passed": boolean (true only if ALL criteria pass),
            "file_created": boolean,
            "no_errors": boolean,
            "append_succeeded": boolean,
            "original_content_preserved": boolean,
            "appended_content_present": boolean,
            "chronological_order": boolean,
            "all_indicators_present": boolean,
            "indicators_found": [list of found indicators],
            "indicators_missing": [list of missing indicators],
            "error": string | null
          }}

          Return ONLY the JSON object.
    model: ${DEFAULT_LLM_MODEL}
    output:
      - test_results
    structured_output_dict:
      test_results: dict
    transition: END
