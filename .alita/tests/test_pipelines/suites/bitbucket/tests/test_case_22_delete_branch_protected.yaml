name: "BB22 - delete_branch: Prevent deletion of 'main' branch"
description: |
  Verify the Bitbucket 'delete_branch' tool prevents deletion of the protected 'main' branch.

  Objective: Test protection mechanism for critical branch

  Expected Behavior:
  - Attempting to delete 'main' branch fails
  - Appropriate error message is returned
  - Error indicates deletion is forbidden
  - No unhandled exceptions
  - Branch remains in repository

toolkits:
  - id: ${BITBUCKET_TOOLKIT_ID}
    name: ${BITBUCKET_TOOLKIT_NAME}

state:
  protected_branches:
    type: list
    value: ["main", "master"]
  expected_error_indicators:
    type: list
    value: 
      - "Cannot delete"
      - "forbidden"
      - "not allowed"
      - "protected"
      - "main or master"
      - "safety"
  delete_main_result:
    type: str
  branch_list:
    type: str
  test_results:
    type: dict

entry_point: attempt_delete_main
nodes:
  - id: attempt_delete_main
    type: toolkit
    continue_on_error: true
    input: []
    input_mapping:
      branch_name:
        type: fixed
        value: "main"
    output:
      - delete_main_result
    structured_output: true
    tool: delete_branch
    toolkit_name: ${BITBUCKET_TOOLKIT_NAME}
    transition: get_branches

  - id: get_branches
    type: toolkit
    continue_on_error: true
    input: []
    input_mapping:
      limit:
        type: fixed
        value: 100
    output:
      - branch_list
    structured_output: true
    tool: list_branches_in_repo
    toolkit_name: ${BITBUCKET_TOOLKIT_NAME}
    transition: validate_results

  - id: validate_results
    type: llm
    input:
      - delete_main_result
      - branch_list
      - expected_error_indicators
      - protected_branches
    input_mapping:
      chat_history:
        type: fixed
        value: []
      system:
        type: fixed
        value: You are a strict quality assurance validator. Only return valid JSON.
      task:
        type: fstring
        value: |
          Analyze the output from 'delete_branch' attempt on the protected 'main' branch.

          Branch List: {branch_list}
          Delete 'main' Result: {delete_main_result}
          Protected Branches: {protected_branches}
          Expected Error Indicators: {expected_error_indicators}

          This is a NEGATIVE test - we expect the tool to PREVENT deletion of the 'main' branch.

          Validation Criteria for test_passed=true:
          REQUIRED (ALL must pass):
          1. main_deletion_blocked: Deletion of 'main' failed with appropriate error
          2. error_message_appropriate: Error message contains one of the expected error indicators
          3. no_unhandled_exception: No truly unhandled Python exception occurred. NOTE: The SDK wraps errors in ToolException and includes a formatted 'Stack Trace:' section in the tool output - this is EXPECTED and HANDLED behavior. Set no_unhandled_exception=true if the error was caught and returned as a ToolException (even if the output contains 'Stack Trace:' or 'Traceback'). Only set false if there is evidence of a crash or uncaught exception outside the tool handler.

          OPTIONAL (nice to have, but don't fail test if missing):
          - branch_list_retrieved: List of branches was retrieved (may fail due to rate limiting)

          Note: This is a negative test focused on deletion prevention. Branch list retrieval is supplementary verification only.

          Return JSON test_results:
          {{
            "test_passed": boolean (true if deletion was properly blocked for main branch),
            "branch_list_retrieved": boolean,
            "main_exists": boolean,
            "main_deletion_blocked": boolean | "skipped",
            "error_message_appropriate": boolean,
            "no_unhandled_exception": boolean,
            "error_indicator_found": "which error indicator was found or 'none'",
            "branches_count": number
          }}

          Return ONLY the JSON object.
    model: ${DEFAULT_LLM_MODEL}
    output:
      - test_results
    structured_output_dict:
      test_results: dict
    transition: END
