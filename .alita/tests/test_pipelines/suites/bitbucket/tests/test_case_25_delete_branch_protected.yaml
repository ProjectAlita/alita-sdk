name: "BB25 - delete_branch: Prevent deletion of main/master branches"
description: |
  Verify the Bitbucket 'delete_branch' tool prevents deletion of protected branches (main/master).

  Objective: Test protection mechanism for critical branches

  Expected Behavior:
  - Attempting to delete 'main' or 'master' branch fails
  - Appropriate error message is returned
  - Error indicates deletion is forbidden
  - No unhandled exceptions
  - Branch remains in repository

toolkits:
  - id: ${BITBUCKET_TOOLKIT_ID}
    name: ${BITBUCKET_TOOLKIT_NAME}

state:
  protected_branches:
    type: list
    value: ["main", "master"]
  expected_error_indicators:
    type: list
    value: 
      - "Cannot delete"
      - "forbidden"
      - "not allowed"
      - "protected"
      - "main or master"
      - "safety"
  delete_main_result:
    type: str
  delete_master_result:
    type: str
  branch_list:
    type: str
  test_results:
    type: dict

entry_point: get_branches
nodes:
  - id: get_branches
    type: toolkit
    input: []
    input_mapping:
      limit:
        type: fixed
        value: 100
    output:
      - branch_list
    structured_output: true
    tool: list_branches_in_repo
    toolkit_name: ${BITBUCKET_TOOLKIT_NAME}
    transition: attempt_delete_main

  - id: attempt_delete_main
    type: toolkit
    continue_on_error: true
    input: []
    input_mapping:
      branch_name:
        type: fixed
        value: "main"
    output:
      - delete_main_result
    structured_output: true
    tool: delete_branch
    toolkit_name: ${BITBUCKET_TOOLKIT_NAME}
    transition: attempt_delete_master

  - id: attempt_delete_master
    type: toolkit
    continue_on_error: true
    input: []
    input_mapping:
      branch_name:
        type: fixed
        value: "master"
    output:
      - delete_master_result
    structured_output: true
    tool: delete_branch
    toolkit_name: ${BITBUCKET_TOOLKIT_NAME}
    transition: validate_results

  - id: validate_results
    type: llm
    input:
      - delete_main_result
      - delete_master_result
      - branch_list
      - expected_error_indicators
      - protected_branches
    input_mapping:
      chat_history:
        type: fixed
        value: []
      system:
        type: fixed
        value: You are a strict quality assurance validator. Only return valid JSON.
      task:
        type: fstring
        value: |
          Analyze the output from 'delete_branch' attempts on protected branches (main/master).

          Branch List: {branch_list}
          Delete 'main' Result: {delete_main_result}
          Delete 'master' Result: {delete_master_result}
          Protected Branches: {protected_branches}
          Expected Error Indicators: {expected_error_indicators}

          This is a NEGATIVE test - we expect the tool to PREVENT deletion of main/master branches.

          Validation Criteria for test_passed=true:
          REQUIRED (ALL must pass):
          1. branch_list_retrieved: List of branches was retrieved successfully
          2. main_deletion_blocked: Deletion of 'main' failed with appropriate error (if 'main' exists)
          3. master_deletion_blocked: Deletion of 'master' failed with appropriate error (if 'master' exists)
          4. error_message_appropriate: Error message indicates deletion is forbidden/not allowed
          5. no_unhandled_exception: No 'traceback', 'stack trace', or 'unhandled' in output

          Note: If a branch doesn't exist in the repository, mark its corresponding deletion check as 'skipped' but don't fail the test.

          Return JSON test_results:
          {{
            "test_passed": boolean (true if deletion was properly blocked for all protected branches that exist),
            "branch_list_retrieved": boolean,
            "main_exists": boolean,
            "master_exists": boolean,
            "main_deletion_blocked": boolean | "skipped",
            "master_deletion_blocked": boolean | "skipped",
            "error_message_appropriate": boolean,
            "no_unhandled_exception": boolean,
            "main_error_indicator_found": "which error indicator was found or 'none'",
            "master_error_indicator_found": "which error indicator was found or 'none'",
            "branches_count": number
          }}

          Return ONLY the JSON object.
    model: ${DEFAULT_LLM_MODEL}
    output:
      - test_results
    structured_output_dict:
      test_results: dict
    transition: END
