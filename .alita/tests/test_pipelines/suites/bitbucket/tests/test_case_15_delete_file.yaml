name: "BB15 - delete_file: Delete existing file"
description: |
  Verify the Bitbucket 'delete_file' tool removes files from the repository.

  Objective: Test successful file deletion

  Expected Behavior:
  - File is created and verified to exist
  - Delete operation succeeds
  - File no longer accessible after deletion
  - Custom commit message is used

toolkits:
  - id: ${BITBUCKET_TOOLKIT_ID}
    name: ${BITBUCKET_TOOLKIT_NAME}

state:
  test_file_path:
    type: str
    value: test-files/bb15-delete-test.txt
  test_content:
    type: str
    value: "This file will be deleted as part of BB15 test"
  expected_success_indicators:
    type: list
    value: ["deleted", "success", "removed", "commit"]
  expected_error_after_delete:
    type: list
    value: ["not found", "does not exist", "404", "no such file"]
  error_indicators:
    type: list
    value: ["error", "failed", "exception", "permission denied"]
  create_result:
    type: str
  file_before_delete:
    type: str
  delete_result:
    type: str
  file_after_delete:
    type: str
  test_results:
    type: dict

entry_point: create_test_file
nodes:
  - id: create_test_file
    type: toolkit
    input:
      - test_file_path
      - test_content
    input_mapping:
      file_path:
        type: variable
        value: test_file_path
      file_contents:
        type: variable
        value: test_content
      branch:
        type: variable
        value: ACTIVE_BRANCH
    output:
      - create_result
    structured_output: true
    tool: create_file
    toolkit_name: ${BITBUCKET_TOOLKIT_NAME}
    transition: verify_file_exists

  - id: verify_file_exists
    type: toolkit
    input:
      - test_file_path
    input_mapping:
      file_path:
        type: variable
        value: test_file_path
      branch:
        type: variable
        value: ACTIVE_BRANCH
    output:
      - file_before_delete
    structured_output: true
    tool: read_file
    toolkit_name: ${BITBUCKET_TOOLKIT_NAME}
    transition: delete_file

  - id: delete_file
    type: toolkit
    input:
      - test_file_path
    input_mapping:
      file_path:
        type: variable
        value: test_file_path
      branch:
        type: variable
        value: ACTIVE_BRANCH
    output:
      - delete_result
    structured_output: true
    tool: delete_file
    toolkit_name: ${BITBUCKET_TOOLKIT_NAME}
    transition: verify_file_deleted

  - id: verify_file_deleted
    type: toolkit
    input:
      - test_file_path
    input_mapping:
      file_path:
        type: variable
        value: test_file_path
      branch:
        type: variable
        value: ACTIVE_BRANCH
    output:
      - file_after_delete
    structured_output: true
    tool: read_file
    toolkit_name: ${BITBUCKET_TOOLKIT_NAME}
    transition: validate_results

  - id: validate_results
    type: llm
    input:
      - create_result
      - file_before_delete
      - delete_result
      - file_after_delete
      - test_content
      - expected_success_indicators
      - expected_error_after_delete
      - error_indicators
    input_mapping:
      chat_history:
        type: fixed
        value: []
      system:
        type: fixed
        value: You are a strict quality assurance validator. Only return valid JSON.
      task:
        type: fstring
        value: |
          Analyze the output from 'delete_file' tool execution.

          Create Result: {create_result}
          File Content Before Delete: {file_before_delete}
          Delete Result: {delete_result}
          File Read After Delete: {file_after_delete}
          Original Test Content: {test_content}
          Expected Success Indicators: {expected_success_indicators}
          Expected Error After Delete: {expected_error_after_delete}
          Error Indicators: {error_indicators}

          This is a POSITIVE test - we expect successful file deletion.

          Validation Criteria (ALL must pass for test_passed=true):
          1. file_created: File was created successfully
          2. file_verified_before: File content was verified before deletion
          3. no_creation_errors: No error indicators in create result
          4. delete_succeeded: Delete operation returned success indicator
          5. file_not_found_after: Read after delete returns "not found" type error
          6. content_matched_before: File content before delete matched original
          7. no_delete_errors: Delete operation did not return unexpected errors

          Return JSON test_results:
          {{
            "test_passed": boolean (true only if ALL criteria pass),
            "file_created": boolean,
            "file_verified_before": boolean,
            "no_creation_errors": boolean,
            "delete_succeeded": boolean,
            "file_not_found_after": boolean,
            "content_matched_before": boolean,
            "no_delete_errors": boolean,
            "success_indicator_found": "which success indicator was found or 'none'",
            "not_found_indicator_after": "which not-found indicator was found or 'none'",
            "error": string | null
          }}

          Return ONLY the JSON object.
    model: ${DEFAULT_LLM_MODEL}
    output:
      - test_results
    structured_output_dict:
      test_results: dict
    transition: END
