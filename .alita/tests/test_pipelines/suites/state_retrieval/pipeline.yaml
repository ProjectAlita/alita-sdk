# State Retrieval Test Suite Configuration
# This file defines the test execution configuration for state retrieval tests
#
# These tests validate pipeline state management and data persistence across nodes

name: state_retrieval
description: Pipeline state retrieval and management tests

# Setup steps executed before running tests
setup:
  # Create GitHub configuration for SDK toolkit
  - name: Setup GitHub Configuration
    type: configuration
    config:
      config_type: github
      alita_title: ${GITHUB_SECRET_NAME:github}
      data:
        access_token: ${GIT_TOOL_ACCESS_TOKEN}
        base_url: "https://api.github.com"

  # Create SDK analysis toolkit for RCA pipeline
  - name: Create SDK Analysis Toolkit
    type: toolkit
    action: create_or_update
    config:
      config_file: ../../configs/git-config.json
      toolkit_type: github
      overrides:
        github_configuration:
          private: true
          alita_title: ${GITHUB_SECRET_NAME:github}
        repository: ${SDK_REPO:ProjectAlita/alita-sdk}
        active_branch: ${SDK_BRANCH:main}
        base_branch: ${SDK_BRANCH:main}
      toolkit_name: sdk-analysis
    save_to_env:
      - key: SDK_TOOLKIT_ID
        value: $.id
      - key: SDK_TOOLKIT_NAME
        value: $.name

# Test execution configuration
execution:
  # Tests are located in tests/ subdirectory
  test_directory: tests

  # Order of test execution (by file pattern or explicit list)
  order:
    - test_case_*.yaml

  # Execution settings
  settings:
    timeout: 120
    parallel: 1  # Sequential for dependent tests
    stop_on_failure: false

# Composable pipelines - RCA for failure analysis
composable_pipelines:
  - file: ../../composable/rca_on_failure.yaml
    env:
      SUITE_NAME: state_retrieval
      RCA_MODEL: ${RCA_MODEL:gpt-4o-mini}
      SDK_TOOLKIT_ID: ${SDK_TOOLKIT_ID}
      SDK_TOOLKIT_NAME: ${SDK_TOOLKIT_NAME:sdk-analysis}
    save_to_env:
      - key: RCA_PIPELINE_ID
        value: $.id
      - key: RCA_PIPELINE_VERSION_ID
        value: $.versions.0.id

# Hooks for custom actions
hooks:
  # Run after each test - RCA on failure
  post_test:
    - name: rca_on_failure
      pipeline_id: ${RCA_PIPELINE_ID}
      condition: "result.get('test_passed') is False"
      input_mapping:
        failure_details: |
          f"""**Test Name:** {result.get('pipeline_name', 'Unknown')}
          **Toolkit:** state_retrieval
          **Status:** Test Failed

          **Error Message:**
          {result.get('error') or result.get('output', {}).get('result', {}).get('error', 'No error message')}

          **Pipeline ID:** {result.get('pipeline_id', 'N/A')}
          **Version ID:** {result.get('version_id', 'N/A')}
          **Execution Time:** {result.get('execution_time', 'N/A')}s

          **Test Output Details:**
          - Test passed: {result.get('test_passed', False)}
          - Tool executed: {result.get('output', {}).get('result', {}).get('tool_executed', 'N/A')}
          - Error: {result.get('output', {}).get('result', {}).get('error', 'None')}
          """
      output_mapping:
        "result['rca']": "rca_result"
        "result['rca_summary']": "rca_summary"

# Cleanup steps executed after tests complete
cleanup:
  # Delete seeded pipelines
  - name: Delete Test Pipelines
    type: pipeline
    config:
      pattern: "SR*"  # All state retrieval test pipelines
    continue_on_error: true

  # Delete the SDK analysis toolkit
  - name: Delete SDK Analysis Toolkit
    type: toolkit
    config:
      toolkit_id: ${SDK_TOOLKIT_ID}
    enabled: true
    continue_on_error: true
