name: "PST17 analyze with improvements"
priority: High
description: |
  Validates that the analyze tool includes improvement suggestions when
  include_improvements flag is enabled.
  
  Objective: Verify analysis with improvement recommendations
  
  Expected Behavior:
  - Tool executes successfully
  - Returns analysis with improvement suggestions
  - Suggestions are actionable and specific
  - Analysis covers both issues and recommendations

toolkits:
  - id: ${TOOLKIT_ID}
    name: ${TOOLKIT_NAME}

state:
  tool_result:
    type: dict
  test_results:
    type: dict
  scope:
    type: str
    value: "collection"
  include_improvements:
    type: str
    value: true
entry_point: invoke_analyze

nodes:
  - id: invoke_analyze
    type: toolkit
    toolkit_name: ${TOOLKIT_NAME}
    tool: analyze
    input:
      - scope
      - include_improvements
    input_mapping:
      scope:
        type: variable
        value: scope
      include_improvements:
        type: variable
        value: include_improvements
    output:

      - tool_result
    structured_output: true
    transition: process_results

  - id: process_results
    type: llm
    model: gpt-4o-2024-11-20
    input:
      - tool_result
    input_mapping:
      system:
        type: fixed
        value: "You are a quality assurance validator."
      task:
        type: fstring
        value: |
          Analyze the output from the 'analyze' tool with improvement suggestions.
          
          Tool Result: {tool_result}
          
          This test validates that analyze includes improvement recommendations.
          
          Perform the following checks:
          1. Confirm the tool executed successfully.
          2. Verify the result contains analysis and improvement suggestions.
          3. Check that suggestions are included when requested.
          4. Validate the improvements are actionable and specific.
          
          Return a JSON object named test_results with the following structure:
          
          {{
            "test_passed": boolean (true if analysis with improvements was generated),
            "summary": "brief description of outcome",
            "error": "error details if failed, null if passed"
          }}
          
          Return **ONLY** the JSON object. No markdown formatting, no additional text.
      chat_history:
        type: fixed
        value: []
    output:
      - test_results
    structured_output_dict:
      test_results: "dict"
    transition: END
