name: "GH07 - Pull Request Workflow"
description: "Test full PR lifecycle: create branch, add file, create PR, get PR, list diffs, close PR, cleanup"

toolkits:
  - id: ${GITHUB_TOOLKIT_ID}
    name: ${GITHUB_TOOLKIT_NAME}

state:
  base_branch:
    type: str
    value: main
  branch_name:
    type: str
  branch_name_base:
    type: str
    value: test/gh10-pr-workflow
  file_contents:
    type: str
  file_path:
    type: str
  file_create_result:
    type: str
  input:
    type: str
  messages:
    type: list
  pr_body:
    type: str
  pr_details:
    type: str
  pr_diffs:
    type: str
  pr_number:
    type: int
  pr_title:
    type: str
  test_results:
    type: dict
  tool_result:
    type: str
entry_point: prepare_test_data
nodes:
  - id: prepare_test_data
    type: code
    code:
      type: fixed
      value: |
        import time
        import random
        import string

        # Generate unique identifiers
        timestamp = time.strftime('%Y%m%d-%H%M%S')
        random_suffix = ''.join(random.choices(string.ascii_lowercase + string.digits, k=4))

        # Branch name
        base_branch_name = alita_state.get('branch_name_base', 'test/gh10-pr-workflow')
        branch_name = f"{base_branch_name}-{timestamp}-{random_suffix}"

        # File to create (PR needs changes)
        file_path = f"test-data/pr-test-{timestamp}-{random_suffix}.txt"
        file_contents = f"""PR test file created at {timestamp}
        Random ID: {random_suffix}
        This file is created to have changes for PR."""

        # PR details
        pr_title = f"[Test] GH10 PR Workflow - {timestamp}-{random_suffix}"
        pr_body = f"""Automated test PR created by GH10 pipeline.

        Timestamp: {timestamp}
        Random ID: {random_suffix}

        This PR will be closed automatically after validation."""

        {"branch_name": branch_name, "file_path": file_path, "file_contents": file_contents, "pr_title": pr_title, "pr_body": pr_body}
    input:
      - branch_name_base
    output:
      - branch_name
      - file_path
      - file_contents
      - pr_title
      - pr_body
    structured_output: true
    transition: create_branch
  - id: create_branch
    type: toolkit
    input:
      - branch_name
    input_mapping:
      proposed_branch_name:
        type: variable
        value: branch_name
    output:
      - tool_result
    structured_output: true
    tool: create_branch
    toolkit_name: testing
    transition: set_active_branch
  - id: set_active_branch
    type: toolkit
    input:
      - branch_name
    input_mapping:
      branch_name:
        type: variable
        value: branch_name
    output:
      - tool_result
    structured_output: true
    tool: set_active_branch
    toolkit_name: testing
    transition: create_file
  - id: create_file
    type: toolkit
    input:
      - file_path
      - file_contents
    input_mapping:
      file_contents:
        type: variable
        value: file_contents
      file_path:
        type: variable
        value: file_path
    output:
      - file_create_result
    structured_output: true
    tool: create_file
    toolkit_name: testing
    transition: create_pull_request
  - id: create_pull_request
    type: toolkit
    input:
      - pr_title
      - pr_body
      - branch_name
      - base_branch
    input_mapping:
      base:
        type: variable
        value: base_branch
      body:
        type: variable
        value: pr_body
      head:
        type: variable
        value: branch_name
      title:
        type: variable
        value: pr_title
    output:
      - tool_result
    structured_output: true
    tool: create_pull_request
    toolkit_name: testing
    transition: extract_pr_number
  - id: extract_pr_number
    type: llm
    input:
      - tool_result
    input_mapping:
      chat_history:
        type: fixed
        value: []
      system:
        type: fixed
        value: You are a data extraction assistant.
      task:
        type: fstring
        value: |
          Extract the pull request number from the following tool result.

          Tool Result: {tool_result}

          Look for the PR number in various formats:
          - PR #123 pattern
          - /pull/123 pattern
          - A 'number' field if it's a JSON object

          Return a JSON object with the following structure:

          {{
            "pr_number": integer (the extracted PR number, or null if not found)
          }}

          Return **EXACTLY** **NONNEGOTIATABLE** only the JSON object with pr_number. Do not use markdown ```json when returning the json. Do not include any explanations, summaries, or additional text.
    model: gpt-4o
    output:
      - pr_number
    structured_output: true
    structured_output_dict:
      pr_number: int
    transition: get_pull_request
  - id: get_pull_request
    type: toolkit
    input:
      - pr_number
    input_mapping:
      pr_number:
        type: variable
        value: pr_number
    output:
      - pr_details
    structured_output: true
    tool: get_pull_request
    toolkit_name: testing
    transition: list_pull_request_diffs
  - id: list_pull_request_diffs
    type: toolkit
    input:
      - pr_number
    input_mapping:
      pr_number:
        type: variable
        value: pr_number
    output:
      - pr_diffs
    structured_output: true
    tool: list_pull_request_diffs
    toolkit_name: testing
    transition: process_results
  - id: process_results
    type: llm
    input:
      - pr_number
      - pr_details
      - pr_diffs
      - pr_title
      - file_path
      - file_create_result
    input_mapping:
      chat_history:
        type: fixed
        value: []
      system:
        type: fixed
        value: You are a quality assurance validator.
      task:
        type: fstring
        value: |
          Analyze the complete pull request workflow results.

          PR Number: {pr_number}
          Expected PR Title: {pr_title}
          Expected File Path: {file_path}
          File Create Result: {file_create_result}
          PR Details Response: {pr_details}
          PR Diffs Response: {pr_diffs}

          Perform the following checks:

          1. Verify file was created successfully (file_create_result does not contain "Unable to create file", "error", or "409")
          2. Verify PR was created successfully (pr_number is not null/empty)
          3. Confirm the PR exists by checking if pr_details contains the PR number or title information
          4. Validate PR diffs contain file changes (diffs_count > 0)
          5. Check if the expected file "{file_path}" appears in the PR diffs
          6. Verify the diffs response is valid and not empty

          IMPORTANT: If file creation failed (check 1 fails), the test should fail with a clear error message explaining that the file creation failed, which caused the PR to have no changes.

          Return a JSON object named test_results with the following structure:

          {{
            "test_passed": boolean (true if all operations succeeded),
            "file_created": boolean (file was created without errors),
            "pr_number": integer or null,
            "pr_exists": boolean (PR details were retrieved successfully),
            "diffs_valid": boolean (diffs response is valid and not empty),
            "diffs_count": integer (number of files changed),
            "file_in_diffs": boolean (expected file found in diffs),
            "pr_details_preview": string (first 300 chars of pr_details),
            "pr_diffs_preview": string (first 300 chars of pr_diffs),
            "error": string or null (error message if any - include file creation error if applicable),
            "failed_checks": list of strings (failed checks if any)
          }}

          Return **EXACTLY** **NONNEGOTIATABLE** only the `test_results` JSON object. Do not use markdown ```json when returning the json. Do not include any explanations, summaries, or additional text.
    model: gpt-4o
    output:
      - test_results
    structured_output_dict:
      test_results: dict
    transition: close_pull_request
  - id: close_pull_request
    type: toolkit
    input:
      - pr_number
    input_mapping:
      state:
        type: fixed
        value: closed
      issue_id:
        type: variable
        value: pr_number
    output:
      - tool_result
    structured_output: true
    tool: update_issue
    toolkit_name: testing
    continue_on_error: true
    transition: delete_branch
  - id: delete_branch
    type: toolkit
    input:
      - branch_name
    input_mapping:
      branch_name:
        type: variable
        value: branch_name
      force:
        type: fixed
        value: true
    output:
      - tool_result
    structured_output: true
    tool: delete_branch
    toolkit_name: testing
    continue_on_error: true
    transition: END