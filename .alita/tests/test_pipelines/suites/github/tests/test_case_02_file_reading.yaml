name: "GH02 - File Reading Workflow"
description: "Test file reading operations: list files in branch, get files from directory, read file content"

toolkits:
  - id: ${GITHUB_TOOLKIT_ID}
    name: ${GITHUB_TOOLKIT_NAME}

state:
  directory_path:
    type: str
    value: test-data
  expected_content:
    type: str
    value: .DS_Store
  file_content:
    type: str
  file_to_read:
    type: str
  files_in_branch:
    type: str
  files_in_directory:
    type: str
  input:
    type: str
  known_file:
    type: str
    value: .gitignore
  messages:
    type: list
  test_results:
    type: dict
  tool_result:
    type: str
  validation_results:
    type: dict
entry_point: list_files_in_branch
nodes:
  - id: list_files_in_branch
    type: toolkit
    input: []
    input_mapping: {}
    output:
      - files_in_branch
    structured_output: true
    tool: list_files_in_main_branch
    toolkit_name: testing
    transition: validate_branch_files
  - id: validate_branch_files
    type: llm
    input:
      - files_in_branch
      - known_file
    input_mapping:
      chat_history:
        type: fixed
        value: []
      system:
        type: fixed
        value: You are a quality assurance validator.
      task:
        type: fstring
        value: |
          Analyze the output from the 'list_files_in_main_branch' tool.

          Tool Result: {files_in_branch}
          Known File to Check: {known_file}

          Perform the following checks:

          1. Confirm the tool executed successfully (the result is not empty or null).
          2. Determine if any files were found (files count > 0).
          3. Check if the known file '{known_file}' exists in the list.
          4. Extract the first 10 file paths as a sample.

          Return a JSON object named validation_results with the following structure:

          {{
            "list_branch_files": boolean (true if files were found),
            "branch_files_count": integer (total number of files),
            "has_known_file": boolean (true if known file is in the list),
            "branch_files_sample": list of strings (first 10 file paths)
          }}

          Return **EXACTLY** **NONNEGOTIATABLE** only the `validation_results` JSON object. Do not use markdown ```json when returning the json. Do not include any explanations, summaries, or additional text.
    model: gpt-4o
    output:
      - validation_results
    structured_output: true
    structured_output_dict:
      validation_results: dict
    transition: get_files_from_directory
  - id: get_files_from_directory
    type: toolkit
    input:
      - directory_path
    input_mapping:
      directory_path:
        type: variable
        value: directory_path
    output:
      - files_in_directory
    structured_output: true
    tool: get_files_from_directory
    toolkit_name: testing
    transition: validate_directory_files
  - id: validate_directory_files
    type: llm
    input:
      - files_in_directory
      - directory_path
      - validation_results
    input_mapping:
      chat_history:
        type: fixed
        value: []
      system:
        type: fixed
        value: You are a quality assurance validator.
      task:
        type: fstring
        value: |
          Analyze the output from the 'get_files_from_directory' tool.

          Tool Result: {files_in_directory}
          Directory Path: {directory_path}
          Previous Validation Results: {validation_results}

          Perform the following tasks:

          1. Confirm the tool executed successfully and files were found.
          2. Count the number of files returned.
          3. Extract the first 10 file paths as a sample.
          4. Pick a file to read: prefer files ending with '.txt' or '.md', otherwise pick the first file.

          Return a JSON object with the following structure:

          {{
            "validation_results": {{
              "list_branch_files": boolean (from previous results),
              "branch_files_count": integer (from previous results),
              "has_known_file": boolean (from previous results),
              "branch_files_sample": list (from previous results),
              "list_dir_files": boolean (true if directory files were found),
              "dir_files_count": integer (total number of files in directory),
              "dir_files_sample": list of strings (first 10 file paths),
              "directory_path": string (the directory path checked)
            }},
            "file_to_read": string (the selected file path to read, or null if no files found)
          }}

          Return **EXACTLY** **NONNEGOTIATABLE** only the JSON object with both validation_results and file_to_read. Do not use markdown ```json when returning the json. Do not include any explanations, summaries, or additional text.
    model: gpt-4o
    output:
      - validation_results
      - file_to_read
    structured_output: true
    structured_output_dict:
      file_to_read: str
      validation_results: dict
    transition: read_known_file
  - id: read_known_file
    type: toolkit
    input:
      - known_file
    input_mapping:
      file_path:
        type: variable
        value: known_file
    output:
      - file_content
    structured_output: true
    tool: read_file
    toolkit_name: testing
    transition: validate_known_file
  - id: validate_known_file
    type: llm
    input:
      - file_content
      - known_file
      - expected_content
      - validation_results
    input_mapping:
      chat_history:
        type: fixed
        value: []
      system:
        type: fixed
        value: You are a quality assurance validator.
      task:
        type: fstring
        value: |
          Analyze the output from the 'read_file' tool for the known file.

          File Content: {file_content}
          Known File: {known_file}
          Expected Content: {expected_content}
          Previous Validation Results: {validation_results}

          Perform the following checks:

          1. Confirm the file was read successfully (content is not empty).
          2. Check if the expected content '{expected_content}' appears in the file.
          3. Determine the length of the file content.

          Return a JSON object named validation_results that merges with the previous validation results and adds:

          {{
            "list_branch_files": boolean (from previous results),
            "branch_files_count": integer (from previous results),
            "has_known_file": boolean (from previous results),
            "branch_files_sample": list (from previous results),
            "list_dir_files": boolean (from previous results),
            "dir_files_count": integer (from previous results),
            "dir_files_sample": list (from previous results),
            "directory_path": string (from previous results),
            "read_known_file": boolean (true if file was read successfully and has content),
            "known_file_has_expected": boolean (true if expected content found in file),
            "known_file_length": integer (length of file content)
          }}

          Return **EXACTLY** **NONNEGOTIATABLE** only the `validation_results` JSON object. Do not use markdown ```json when returning the json. Do not include any explanations, summaries, or additional text.
    model: gpt-4o
    output:
      - validation_results
    structured_output: true
    structured_output_dict:
      validation_results: dict
    transition: read_directory_file
  - id: read_directory_file
    type: toolkit
    input:
      - file_to_read
    input_mapping:
      file_path:
        type: variable
        value: file_to_read
    output:
      - file_content
    structured_output: true
    tool: read_file
    toolkit_name: testing
    transition: process_results
  - id: process_results
    type: llm
    input:
      - file_content
      - file_to_read
      - validation_results
    input_mapping:
      chat_history:
        type: fixed
        value: []
      system:
        type: fixed
        value: You are a quality assurance validator.
      task:
        type: fstring
        value: |
          Analyze the final results from the file reading workflow.

          Directory File Content: {file_content}
          Directory File Path: {file_to_read}
          Validation Results: {validation_results}

          Perform the following tasks:

          1. Validate that the directory file was read successfully (content is not empty).
          2. Determine the length of the directory file content.
          3. Evaluate overall test success:
             - Test passes if: list_files_in_main_branch succeeded AND read_known_file succeeded
             - Directory operations are bonus (may fail if test-data doesn't exist)

          Return a JSON object named test_results with the following structure:

          {{
            "test_passed": boolean (true if list_branch_files AND read_known_file are both true),
            "operations": {{
              "list_files_in_main_branch": boolean (from validation_results.list_branch_files),
              "get_files_from_directory": boolean (from validation_results.list_dir_files),
              "read_known_file": boolean (from validation_results.read_known_file),
              "read_directory_file": boolean (true if directory file was read successfully)
            }},
            "details": {{
              "branch_files_count": integer (from validation_results.branch_files_count),
              "dir_files_count": integer (from validation_results.dir_files_count),
              "known_file_length": integer (from validation_results.known_file_length),
              "dir_file_path": string (the directory file path),
              "dir_file_length": integer (length of directory file content)
            }},
            "error": string | null
          }}

          Return **EXACTLY** **NONNEGOTIATABLE** only the `test_results` JSON object. Do not use markdown ```json when returning the json. Do not include any explanations, summaries, or additional text.
    model: gpt-4o
    output:
      - test_results
    structured_output: false
    structured_output_dict:
      test_results: dict
    transition: END