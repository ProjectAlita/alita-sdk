name: "GH01 - List Branches"
description: "Verify list_branches_in_repo tool returns branches including expected branch names"

toolkits:
  - id: ${GITHUB_TOOLKIT_ID}
    name: ${GITHUB_TOOLKIT_NAME}

state:
  input:
    type: str
  messages:
    type: list
  tool_result:
    type: str
  trimmed_result:
    type: dict
  test_results:
    type: dict

entry_point: invoke_list_branches

nodes:
  - id: invoke_list_branches
    type: toolkit
    tool: list_branches_in_repo
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input: []
    input_mapping: {}
    output:
      - tool_result
    structured_output: true
    transition: trim_branches

  - id: trim_branches
    type: code
    code:
      type: fixed
      value: |
        import json
        raw = alita_state.get("tool_result", "")
        branches = []
        try:
            if isinstance(raw, list):
                branches = raw
            elif isinstance(raw, str):
                branches = json.loads(raw)
        except Exception:
            pass
        branch_names = [b.get("name", str(b)) if isinstance(b, dict) else str(b) for b in branches]
        has_main = "main" in branch_names
        data = {"branches_count": len(branch_names), "has_main_branch": has_main, "branches_sample": branch_names[:5], "tool_executed": len(branch_names) > 0}
        {"trimmed_result": data}
    input:
      - tool_result
    output:
      - trimmed_result
    structured_output: true
    transition: process_results

  - id: process_results
    type: llm
    model: gpt-4o
    input:
      - trimmed_result
    input_mapping:
      system:
        type: fixed
        value: "You are a quality assurance validator."
      task:
        type: fstring
        value: |
          Analyze the pre-processed output from the 'list_branches_in_repo' tool.

          Trimmed Result: {trimmed_result}

          The trimmed_result contains:
          - branches_count: total number of branches found
          - has_main_branch: whether 'main' branch exists
          - branches_sample: first 5 branch names
          - tool_executed: whether the tool ran successfully

          Do NOT echo back the full data. Keep response under 200 tokens.

          Return a JSON object named test_results with the following structure:

          {
          "test_passed": boolean (true if tool_executed is true AND branches_count > 0 AND has_main_branch is true),
          "tool_executed": boolean,
          "branches_count": integer,
          "has_main_branch": boolean,
          "branches_sample": list of strings (first 5 branches),
          "error": string | null
          }

          Return **EXACTLY** **NONNEGOTIATABLE** only the `test_results` JSON object. Do not use markdown ```json when returning the json. Do not include any explanations, summaries, or additional text.
      chat_history:
        type: fixed
        value: []
    output:
      - test_results
    structured_output_dict:
        test_results: "dict"
    transition: END
