name: "GH13 - Update File: Empty Replace"
description: "Test update_file with empty replacement to delete content"
priority: Critical

toolkits:
  - id: ${GITHUB_TOOLKIT_ID}
    name: ${GITHUB_TOOLKIT_NAME}

state:
  target_branch:
    type: str
  file_path:
    type: str
  original_content:
    type: str
  new_content:
    type: str
  old_content:
    type: str
  file_query:
    type: str
  create_result:
    type: str
  update_result:
    type: str
  verified_content:
    type: str
  test_results:
    type: dict

entry_point: prepare_test_data

nodes:
  - id: prepare_test_data
    type: code
    code:
      type: fixed
      value: |
        import time
        import random
        import string

        timestamp = time.strftime('%Y%m%d-%H%M%S')
        random_id = ''.join(random.choices(string.ascii_lowercase + string.digits, k=6))
        target_branch = f"tc-test-gh18-{timestamp}-{random_id}"
        file_path = f"test-data/update-test/gh18-delete-{random_id}.txt"

        nl = chr(10)
        original_content = (
            "keep this line" + nl +
            "delete this section start" + nl +
            "this entire section should be removed" + nl +
            "including this line" + nl +
            "delete this section end" + nl +
            "keep this line too" + nl +
            f"created at {timestamp}"
        )

        {"target_branch": target_branch, "file_path": file_path, "original_content": original_content}
    input: []
    output:
      - target_branch
      - file_path
      - original_content
    structured_output: true
    transition: create_branch

  - id: create_branch
    type: toolkit
    tool: create_branch
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - target_branch
    input_mapping:
      proposed_branch_name:
        type: variable
        value: target_branch
    output:
      - create_result
    structured_output: true
    transition: set_active_branch

  - id: set_active_branch
    type: toolkit
    tool: set_active_branch
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - target_branch
    input_mapping:
      branch_name:
        type: variable
        value: target_branch
    output:
      - create_result
    structured_output: true
    transition: create_file

  - id: create_file
    type: toolkit
    tool: create_file
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - file_path
      - original_content
    input_mapping:
      file_path:
        type: variable
        value: file_path
      file_contents:
        type: variable
        value: original_content
    output:
      - create_result
    structured_output: true
    transition: build_update_query

  - id: build_update_query
    type: code
    code:
      type: fixed
      value: |
        file_path = alita_state.get('file_path')

        old_content = """delete this section start
        this entire section should be removed
        including this line
        delete this section end"""

        file_query = f"""{file_path}
        OLD <<<<
        {old_content}
        >>>> OLD
        NEW <<<<

        >>>> NEW"""

        nl = chr(10)
        new_content = nl

        {"new_content": new_content, "file_query": file_query, "old_content": old_content}
    input:
      - file_path
    output:
      - new_content
      - file_query
      - old_content
    structured_output: true
    transition: update_file

  - id: update_file
    type: toolkit
    tool: update_file
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - file_query
    input_mapping:
      file_query:
        type: variable
        value: file_query
    output:
      - update_result
    structured_output: true
    transition: verify_update

  - id: verify_update
    type: toolkit
    tool: read_file
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - file_path
    input_mapping:
      file_path:
        type: variable
        value: file_path
    output:
      - verified_content
    structured_output: true
    transition: validate_result

  - id: validate_result
    type: llm
    model: gpt-4o-2024-11-20
    input:
      - update_result
      - verified_content
    input_mapping:
      system:
        type: fixed
        value: "you are a quality assurance validator."
      task:
        type: fstring
        value: |
          analyze the empty replacement (deletion) update_file operation results.

          update result: {update_result}
          file content after update: {verified_content}

          perform the following checks:

          1. verify update executed without errors
          2. confirm deleted section removed ("delete this section" not present)
          3. verify removed content gone ("should be removed" not in file)
          4. check line before deletion preserved ("keep this line")
          5. check line after deletion preserved ("keep this line too")
          6. ensure file not completely empty (has content)

          return a json object with:
          {{
            "test_passed": true/false,
            "summary": "brief outcome description",
            "error": null or "error description"
          }}

          return **only** the json object. no markdown formatting, no additional text.
      chat_history:
        type: fixed
        value: []
    output:
      - test_results
    structured_output_dict:
      test_results: "dict"
    transition: cleanup_branch

  - id: cleanup_branch
    type: toolkit
    tool: delete_branch
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - target_branch
    input_mapping:
      branch_name:
        type: variable
        value: target_branch
      force:
        type: fixed
        value: true
    output:
      - create_result
    structured_output: true
    continue_on_error: true
    transition: END
