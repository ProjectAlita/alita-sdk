# Confluence Toolkit Test Suite Configuration
# This file defines setup, execution, and cleanup for the test suite
#
# This configuration is toolkit-agnostic - all specificity comes from
# the config values, not hardcoded handlers in setup.py/cleanup.py

name: confluence_toolkit
description: Confluence toolkit integration tests

# Environment variable mappings
# These map .env variables to config values used in setup
env_mapping:
  toolkit_config: ${CONFLUENCE_CONFIG_PATH:../../configs/confluence-config.json}
  space: ${CONFLUENCE_SPACE:AT}
  base_url: ${CONFLUENCE_BASE_URL:https://epamelitea.atlassian.net/}
  api_key: ${CONFLUENCE_API_KEY}
  username: ${CONFLUENCE_USERNAME}

# Setup steps executed before running tests
# Steps are executed in order; if a step fails, setup stops
setup:
  # Step 1: Ensure Confluence credentials configuration exists
  - name: Setup Confluence Configuration
    type: configuration
    config:
      config_type: confluence
      alita_title: ${CONFLUENCE_SECRET_NAME:confluence}
      data:
        api_key: ${CONFLUENCE_API_KEY}
        base_url: ${CONFLUENCE_BASE_URL:https://epamelitea.atlassian.net/}
        username: ${CONFLUENCE_USERNAME}

  # Step 2: Create or update the Confluence toolkit on the platform
  - name: Create Confluence Toolkit
    type: toolkit
    action: create_or_update
    config:
      # Load base config from tool_configs
      config_file: ../../configs/confluence-config.json
      toolkit_type: confluence
      # Override/substitute values from environment
      overrides:
        # Credentials must use secret reference format (platform requirement)
        confluence_configuration:
          private: true
          alita_title: ${CONFLUENCE_SECRET_NAME:confluence}
        space: ${CONFLUENCE_SPACE:AT}
        cloud: true
      # Name for the toolkit on platform
      toolkit_name: ${CONFLUENCE_TOOLKIT_NAME:confluence-testing}
    # Save created toolkit ID to environment for pipeline substitution
    save_to_env:
      - key: CONFLUENCE_TOOLKIT_ID
        value: $.id
      - key: CONFLUENCE_TOOLKIT_NAME
        value: $.name

# Composable pipelines - seeded first, used by hooks and other pipelines
# These are reusable pipeline components that can be invoked conditionally
composable_pipelines: []

# Test execution configuration
execution:
  # Order of test execution (by file pattern or explicit list)
  # Tests are located in tests/ subdirectory
  test_directory: tests
  order:
    - test_case_01_*.yaml  # CF01 - Get Page Tree
    - test_case_02_*.yaml  # CF02 - Get Pages with Label
    - test_case_03_*.yaml  # CF03 - Read Page by ID
    - test_case_04_*.yaml  # CF04 - Search Pages
    - test_case_05_*.yaml  # CF05 - Search by Title
    - test_case_06_*.yaml  # CF06 - Get Page ID by Title
    - test_case_07_*.yaml  # CF07 - Create and Delete Page
    - test_case_08_*.yaml  # CF08 - List Pages with Label
    - test_case_09_*.yaml  # CF09 - Get Page Attachments
    - test_case_10_*.yaml  # CF10 - Update Page by ID
    - test_case_11_*.yaml  # CF11 - Site Search (Happy Path)
    - test_case_12_*.yaml  # CF12 - Site Search (No Results)
    - test_case_13_*.yaml  # CF13 - Get Page with Image Descriptions (Happy Path)
    - test_case_14_*.yaml  # CF14 - Get Page with Image Descriptions (Page Not Found)
    - test_case_15_*.yaml  # CF15 - Execute Generic Confluence (GET Request)
    - test_case_16_*.yaml  # CF16 - Execute Generic Confluence (POST Request)
    - test_case_17_*.yaml  # CF17 - Create Pages (Batch Creation)
    - test_case_18_*.yaml  # CF18 - Create Pages (Single Page)
    - test_case_19_*.yaml  # CF19 - Update Page by Title (Content Update)
    - test_case_20_*.yaml  # CF20 - Update Page by Title (Page Not Found)
    - test_case_21_*.yaml  # CF21 - Update Pages (Batch Different Content)
    - test_case_22_*.yaml  # CF22 - Update Pages (Batch Same Content)
    - test_case_23_*.yaml  # CF23 - Update Labels (Add Labels)
    - test_case_24_*.yaml  # CF24 - Update Labels (No Page IDs)

  # Variables to substitute in test YAML files
  substitutions:
    CONFLUENCE_TOOLKIT_ID: ${CONFLUENCE_TOOLKIT_ID}
    CONFLUENCE_TOOLKIT_NAME: ${CONFLUENCE_TOOLKIT_NAME}
    TIMESTAMP: ${TIMESTAMP}

  # Execution settings
  settings:
    timeout: 120
    parallel: 1  # Sequential for dependent tests
    stop_on_failure: false

# Cleanup steps executed after tests complete
# Steps are executed in order; failures are logged but don't stop cleanup
cleanup:
  # Step 1: Delete seeded pipelines
  - name: Delete Test Pipelines
    type: pipeline
    config:
      pattern: "CF*"  # All Confluence test pipelines
    continue_on_error: true

  # Step 2: Delete the test toolkit
  - name: Delete Test Toolkit
    type: toolkit
    config:
      toolkit_id: ${CONFLUENCE_TOOLKIT_ID}
    enabled: true
    continue_on_error: true

# Hooks for custom actions
hooks:
  # Run before any setup steps
  pre_setup: []

  # Run after all setup steps complete
  post_setup: []

  # Run after each test
  post_test: []

  # Run before cleanup starts
  pre_cleanup: []

  # Run after cleanup completes
  post_cleanup: []
