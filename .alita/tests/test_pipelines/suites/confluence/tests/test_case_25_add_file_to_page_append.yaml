name: "CF25 - Add File to Page (Append File)"
priority: Critical
description: |
  Verify `add_file_to_page` tool uploads file from artifact and adds it to page.

  Objective: Ensure tool can retrieve file from artifact, upload to Confluence, and add reference to page content.

  Expected Behavior:
  - Tool executes successfully without errors.
  - File is uploaded to Confluence as attachment.
  - File reference is added to page content (inline for images, link for other files).
  - Returns success message with format "File '<filename>' uploaded and added to page <page_id> as <file_type>. View at: <page_url>".

toolkits:
  - id: ${CONFLUENCE_TOOLKIT_ID}
    name: ${CONFLUENCE_TOOLKIT_NAME}

state:
  page_id:
    type: str
    value: '140869772'
  filepath:
    type: str
    value: '${TEST_ARTIFACT_ID}'
  filename:
    type: str
    value: 'test_upload.txt'
  position:
    type: str
    value: 'append'
  tool_result:
    type: str
  test_results:
    type: dict

entry_point: invoke_add_file_to_page

nodes:
  - id: invoke_add_file_to_page
    type: toolkit
    tool: add_file_to_page
    toolkit_name: ${CONFLUENCE_TOOLKIT_NAME}
    input:
      - page_id
      - filepath
      - filename
      - position
    input_mapping:
      page_id:
        type: variable
        value: page_id
      filepath:
        type: variable
        value: filepath
      filename:
        type: variable
        value: filename
      position:
        type: variable
        value: position
    output:
      - tool_result
    structured_output: true
    transition: process_results

  - id: process_results
    type: llm
    model: gpt-4o
    input:
      - tool_result
      - page_id
      - filename
    input_mapping:
      system:
        type: fixed
        value: "You are a quality assurance validator."
      task:
        type: fstring
        value: |
          Analyze the output from the 'add_file_to_page' tool.

          Tool Result: {tool_result}
          Page ID: {page_id}
          Filename: {filename}

          Perform the following checks:
          1. Confirm the tool executed successfully (result is not empty, null, or error message).
          2. Verify the output contains success message with "File" and "uploaded and added to page".
          3. Check that the message includes the page ID and file type information.
          4. Ensure "View at:" URL is present in the response.

          Return a JSON object named test_results with the following structure:

          {{
            "test_passed": boolean,
            "summary": "Brief description of outcome",
            "error": "Error details if failed, null if passed"
          }}

          Return **ONLY** the JSON object. No markdown, no additional text.
      chat_history:
        type: fixed
        value: []
    output:
      - test_results
    structured_output_dict:
      test_results: "dict"
    transition: END
