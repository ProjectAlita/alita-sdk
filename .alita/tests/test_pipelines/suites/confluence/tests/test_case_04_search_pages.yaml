name: "CF04 - Search Pages"
description: "Verify search_pages tool searches for pages by query text in title or content"

toolkits:
  - id: ${CONFLUENCE_TOOLKIT_ID}
    name: ${CONFLUENCE_TOOLKIT_NAME}

state:
  query:
    type: str
    value: "Template"
  tool_result:
    type: str
  test_results:
    type: dict

entry_point: invoke_search_pages

nodes:
  - id: invoke_search_pages
    type: toolkit
    tool: search_pages
    toolkit_name: ${CONFLUENCE_TOOLKIT_NAME}
    input:
      - query
    input_mapping:
      query:
        type: variable
        value: query
    output:
      - tool_result
    structured_output: true
    transition: process_results

  - id: process_results
    type: llm
    model: gpt-4o
    input:
      - tool_result
      - query
    input_mapping:
      system:
        type: fixed
        value: "You are a quality assurance validator."
      task:
        type: fstring
        value: |
          Analyze the output from the 'search_pages' tool.

          Tool Result: {tool_result}
          Query: {query}

          Perform the following checks:

          1. Confirm the tool executed successfully (the result is not empty or null).
          2. Verify the output contains search results with page information.
          3. Check if pages were found matching the search query.
          4. Count the number of pages in the search results.
          5. Validate that each result has page details (page_id, page_title, page_url, content).

          Return a JSON object named test_results with the following structure:

          {{
            "test_passed": boolean (true if tool executed and returned valid search results),
            "tool_executed": boolean (true if tool ran without errors),
            "results_found": boolean (true if at least one page was returned),
            "result_count": integer (number of pages in search results),
            "has_valid_structure": boolean (true if results have page_id, page_title, page_url fields),
            "sample_page_title": string (title of first page found, or null if none),
            "failed_checks": [string] // list of failed assertions
          }}

          Return **EXACTLY** **NONNEGOTIATABLE** only the `test_results` JSON object. Do not use markdown ```json when returning the json. Do not include any explanations, summaries, or additional text.
      chat_history:
        type: fixed
        value: []
    output:
      - test_results
    structured_output_dict:
        test_results: "dict"
    transition: END
