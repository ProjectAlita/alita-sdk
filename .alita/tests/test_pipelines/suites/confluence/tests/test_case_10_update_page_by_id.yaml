name: "CF10 - Update Page by ID"
description: "Verify update_page_by_id tool updates page content and labels, then read and delete"

toolkits:
  - id: ${CONFLUENCE_TOOLKIT_ID}
    name: ${CONFLUENCE_TOOLKIT_NAME}

state:
  create_result:
    type: str
  delete_result:
    type: str
  initial_body:
    type: str
  is_page_read:
    type: str
    value: ''
  label:
    type: list
    value:
      - automation
      - updated
  page_id:
    type: str
  page_title:
    type: str
  read_result:
    type: str
  representation:
    type: str
    value: storage
  space:
    type: str
    value: AT
  status:
    type: str
    value: current
  test_data:
    type: dict
  test_results:
    type: dict
  timestamp:
    type: str
    value: 20260126-185712
  update_result:
    type: str
  updated_body:
    type: str
entry_point: generate_test_data
interrupt_after: []
nodes:
  - id: generate_test_data
    type: llm
    input:
      - timestamp
    input_mapping:
      chat_history:
        type: fixed
        value: []
      system:
        type: fixed
        value: You are a test data generator. Generate random, unique test data for Confluence page testing.
      task:
        type: fstring
        value: |
          Generate random test data for a Confluence page update test using timestamp: {timestamp}

          Create unique and randomized values for:
          1. Page title - must include TC_10_Update and timestamp, plus a random UUID or random words
          2. Initial body content - generate random HTML paragraph with diverse content (200-300 chars)
          3. Updated body content - generate completely different random HTML content (200-300 chars)

          Requirements:
          - Use varied vocabulary and realistic content
          - Make initial and updated content clearly different
          - Include proper HTML paragraph tags
          - Ensure page title is unique using timestamp and random elements

              "page_title": "unique title with TC_10_Update_{timestamp}_randomid",
              "initial_body": "<p>Random initial content here...</p>",
              "updated_body": "<p>Completely different updated content here...</p>"


          Return **EXACTLY** **NONNEGOTIATABLE** only the fields object. Do not use markdown ```json. Do not include explanations.
    model: gpt-4o
    output:
      - test_data
      - page_title
      - initial_body
      - updated_body
    structured_output: true
    structured_output_dict:
      test_data: dict
    transition: create_page
  - id: create_page
    type: toolkit
    input:
      - space
      - page_title
      - initial_body
      - status
      - representation
    input_mapping:
      body:
        type: variable
        value: initial_body
      representation:
        type: variable
        value: representation
      space:
        type: variable
        value: space
      status:
        type: variable
        value: status
      title:
        type: variable
        value: page_title
    output:
      - create_result
    structured_output: true
    tool: create_page
    toolkit_name: confluence-testing
    transition: extract_page_id
  - id: extract_page_id
    type: llm
    input:
      - create_result
    input_mapping:
      chat_history:
        type: fixed
        value: []
      system:
        type: fixed
        value: You are a data extraction assistant.
      task:
        type: fstring
        value: |
          Extract the page ID from the create_page result.

          Create Result: {create_result}

          Find the 'id' field in the page details and return ONLY the page ID as a string.

          Return **EXACTLY** **NONNEGOTIATABLE** only the page ID as a plain string (no JSON, no quotes, no explanations).
    model: gpt-4o
    output:
      - page_id
    structured_output: false
    transition: update_page
  - id: update_page
    type: toolkit
    input:
      - page_id
      - updated_body
      - label
      - representation
    input_mapping:
      new_body:
        type: variable
        value: updated_body
      new_labels:
        type: variable
        value: label
      page_id:
        type: variable
        value: page_id
      representation:
        type: variable
        value: representation
    output:
      - update_result
    structured_output: true
    tool: update_page_by_id
    toolkit_name: confluence-testing
    transition: read_updated_page
  - id: read_updated_page
    type: toolkit
    input:
      - page_id
    input_mapping:
      page_id:
        type: variable
        value: page_id
    output:
      - read_result
    structured_output: true
    tool: read_page_by_id
    toolkit_name: confluence-testing
    transition: validate_update
  - id: validate_update
    type: llm
    input:
      - update_result
      - read_result
      - page_id
      - updated_body
    input_mapping:
      chat_history:
        type: fixed
        value: []
      system:
        type: fixed
        value: You are a quality assurance validator.
      task:
        type: fstring
        value: |
          Analyze the update and read results.

          Update Result: {update_result}
          Read Result: {read_result}
          Page ID: {page_id}
          Expected Body: {updated_body}

          Perform the following checks:

          1. Verify update was successful (update result contains "updated successfully").
          2. Verify page ID is mentioned in update result.
          3. Check if read result contains the updated content.
          4. Validate that labels information is present in update result.

          Return a JSON object with the following structure:

          {{
            "validation_results": {{
              "update_successful": boolean (true if update completed),
              "page_id_in_result": boolean (true if page ID is in update result),
              "content_updated": boolean (true if read result contains updated content),
              "has_labels": boolean (true if labels mentioned in update result)
            }}
          }}

          Return **EXACTLY** **NONNEGOTIATABLE** only the JSON object. Do not use markdown ```json when returning the json. Do not include any explanations, summaries, or additional text.
    model: gpt-4o
    output:
      - test_results
    structured_output_dict:
      test_results: dict
    transition: delete_page
  - id: process_results
    type: llm
    input:
      - delete_result
      - test_results
    input_mapping:
      chat_history:
        type: fixed
        value: []
      system:
        type: fixed
        value: You are a quality assurance validator.
      task:
        type: fstring
        value: |
          Analyze the complete workflow results.

          Delete Result: {delete_result}
          Validation Results: {test_results}

          Perform the following checks:

          1. Verify the page was deleted successfully.
          2. Evaluate overall test success (create, update, read, delete all succeeded).

          Return a JSON object named test_results with the following structure:

          {{
            "test_passed": boolean (true if all operations succeeded),
            "tool_executed": boolean (true if all tools ran without errors),
            "page_created": boolean (true),
            "page_updated": boolean (from validation_results),
            "content_verified": boolean (from validation_results),
            "page_deleted": boolean (true if delete was successful)
            "failed_checks": [string] // list of failed assertions
          }}

          Return **EXACTLY** **NONNEGOTIATABLE** only the `test_results` JSON object. Do not use markdown ```json when returning the json. Do not include any explanations, summaries, or additional text.
    model: gpt-4o
    output:
      - test_results
    structured_output_dict:
      test_results: dict
    transition: END
  - id: delete_page
    type: toolkit
    input:
      - page_id
    input_mapping:
      page_id:
        type: variable
        value: page_id
      page_title:
        type: fixed
        value: null
    output:
      - delete_result
    structured_output: false
    tool: delete_page
    toolkit_name: confluence-testing
    transition: process_results
