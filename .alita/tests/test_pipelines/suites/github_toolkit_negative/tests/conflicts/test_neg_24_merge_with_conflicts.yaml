# NEG_24: Merge PR with Same Head and Base
# Verifies that merge operations return actionable errors for conflicts
# This tests creating a PR with same head/base which should fail

name: "NEG24 - Create PR with Same Head and Base"
description: "Verify create_pull_request returns actionable error when head equals base"

toolkits:
  - id: ${GITHUB_TOOLKIT_ID}
    name: ${GITHUB_TOOLKIT_NAME}

state:
  input:
    type: str
  messages:
    type: list
  branch_name:
    type: str
    value: "main"  # Same as base
  tool_result:
    type: str
  test_results:
    type: dict

entry_point: invoke_create_pr_same_branches

nodes:
  - id: invoke_create_pr_same_branches
    type: toolkit
    tool: create_pull_request
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - branch_name
    input_mapping:
      pr_title:
        type: fixed
        value: "Test PR - Same Head and Base"
      pr_body:
        type: fixed
        value: "This PR should fail - head equals base"
      head_branch:
        type: variable
        value: branch_name
      base_branch:
        type: variable
        value: branch_name
    output:
      - tool_result
    structured_output: true
    transition: validate_error

  - id: validate_error
    type: code
    code:
      type: fixed
      value: |
        result = alita_state.get('tool_result')
        branch_name = alita_state.get('branch_name')
        result_str = str(result).lower() if result else ''

        # Error quality checks
        has_conflict_error = any(term in result_str for term in [
            'same', 'identical', 'no difference', 'nothing to compare',
            'head and base', 'already', 'no commits', '422', 'validation failed'
        ])

        references_branches = any(term in result_str for term in ['head', 'base', 'branch'])

        no_traceback = 'traceback' not in result_str

        # Should not indicate PR was created
        not_success = 'created' not in result_str or 'error' in result_str or 'failed' in result_str

        test_passed = has_conflict_error and not_success and no_traceback

        test_results = {
            "test_passed": test_passed,
            "error_quality": {
                "indicates_same_branch_error": has_conflict_error,
                "references_branches": references_branches,
                "no_raw_traceback": no_traceback,
                "not_success_response": not_success
            },
            "branch_used": branch_name,
            "actual_response": result_str[:500],
            "improvement_needed": [] if test_passed else [
                "Missing same-branch error indicator" if not has_conflict_error else None,
                "Does not reference head/base" if not references_branches else None,
                "Contains raw traceback" if not no_traceback else None,
                "Incorrectly indicates PR created" if not not_success else None
            ]
        }
        test_results["improvement_needed"] = [x for x in test_results["improvement_needed"] if x]
        test_results
    input:
      - tool_result
      - branch_name
    output:
      - messages
    structured_output: false
    transition: END
