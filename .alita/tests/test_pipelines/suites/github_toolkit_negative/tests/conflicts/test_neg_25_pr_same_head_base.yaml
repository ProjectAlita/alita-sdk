# NEG_25: PR with No Changes
# Verifies that creating PR between branches with no diff returns actionable error
# Expected: Clear error message about no changes to merge

name: "NEG25 - Create PR with No Commits Difference"
description: "Verify create_pull_request handles case where branches are identical"

toolkits:
  - id: ${GITHUB_TOOLKIT_ID}
    name: ${GITHUB_TOOLKIT_NAME}

state:
  input:
    type: str
  messages:
    type: list
  head_branch:
    type: str
    value: "main"
  base_branch:
    type: str
    value: "main"
  tool_result:
    type: str
  test_results:
    type: dict

entry_point: invoke_create_pr

nodes:
  - id: invoke_create_pr
    type: toolkit
    tool: create_pull_request
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - head_branch
      - base_branch
    input_mapping:
      pr_title:
        type: fixed
        value: "[Test] PR with identical branches"
      pr_body:
        type: fixed
        value: "Testing error handling for identical branches"
      head_branch:
        type: variable
        value: head_branch
      base_branch:
        type: variable
        value: base_branch
    output:
      - tool_result
    structured_output: true
    transition: validate_error

  - id: validate_error
    type: code
    code:
      type: fixed
      value: |
        result = alita_state.get('tool_result')
        head_branch = alita_state.get('head_branch')
        base_branch = alita_state.get('base_branch')
        result_str = str(result).lower() if result else ''

        # Error quality checks
        has_no_diff_error = any(term in result_str for term in [
            'no difference', 'nothing to compare', 'identical',
            'same branch', 'no commits', 'already', '422',
            'head and base', 'a]re the same'
        ])

        # Should clearly indicate the problem
        is_actionable = any(term in result_str for term in [
            'different branch', 'make commits', 'push changes',
            'error', 'failed', 'cannot'
        ])

        no_traceback = 'traceback' not in result_str

        # Should not indicate PR was created
        not_success = 'url' not in result_str or 'error' in result_str or 'failed' in result_str

        test_passed = has_no_diff_error and not_success and no_traceback

        test_results = {
            "test_passed": test_passed,
            "error_quality": {
                "indicates_no_diff": has_no_diff_error,
                "is_actionable": is_actionable,
                "no_raw_traceback": no_traceback,
                "not_success_response": not_success
            },
            "head_branch": head_branch,
            "base_branch": base_branch,
            "actual_response": result_str[:500],
            "improvement_needed": [] if test_passed else [
                "Missing 'no difference' indicator" if not has_no_diff_error else None,
                "Error not actionable" if not is_actionable else None,
                "Contains raw traceback" if not no_traceback else None,
                "Incorrectly indicates PR created" if not not_success else None
            ]
        }
        test_results["improvement_needed"] = [x for x in test_results["improvement_needed"] if x]
        test_results
    input:
      - tool_result
      - head_branch
      - base_branch
    output:
      - messages
    structured_output: false
    transition: END
