# GitHub Toolkit Negative Tests - Input Validation Category
# Run with: ./run_all_suites.sh github_toolkit_negative:pipeline_validation.yaml

name: github_toolkit_negative_validation
description: GitHub toolkit input validation error handling tests

env_mapping:
  toolkit_config: ${GIT_CONFIG_PATH:../../../tool_configs/git-config.json}
  access_token: ${GIT_TOOL_ACCESS_TOKEN}
  repository: ${GITHUB_TEST_REPO:ProjectAlita/elitea-testing}
  base_branch: ${GITHUB_BASE_BRANCH:main}

setup:
  - name: Setup GitHub Configuration
    type: configuration
    config:
      config_type: github
      alita_title: ${GITHUB_SECRET_NAME:github}
      data:
        access_token: ${GIT_TOOL_ACCESS_TOKEN}
        base_url: "https://api.github.com"

  - name: Create GitHub Toolkit
    type: toolkit
    action: create_or_update
    config:
      config_file: ../../configs/git-config.json
      toolkit_type: github
      overrides:
        github_configuration:
          private: true
          alita_title: ${GITHUB_SECRET_NAME:github}
        repository: ${GITHUB_TEST_REPO:ProjectAlita/elitea-testing}
        active_branch: ${GITHUB_BASE_BRANCH:main}
        base_branch: ${GITHUB_BASE_BRANCH:main}
      toolkit_name: ${GITHUB_TOOLKIT_NAME:testing-negative-validation}
    save_to_env:
      - key: GITHUB_TOOLKIT_ID
        value: $.id
      - key: GITHUB_TOOLKIT_NAME
        value: $.name

  # SDK analysis toolkit for RCA
  - name: Create SDK Analysis Toolkit
    type: toolkit
    action: create_or_update
    config:
      config_file: ../../configs/git-config.json
      toolkit_type: github
      overrides:
        github_configuration:
          private: true
          alita_title: ${GITHUB_SECRET_NAME:github}
        repository: ${SDK_REPO:ProjectAlita/alita-sdk}
        active_branch: ${SDK_BRANCH:main}
        base_branch: ${SDK_BRANCH:main}
      toolkit_name: sdk-analysis-validation
    save_to_env:
      - key: SDK_TOOLKIT_ID
        value: $.id
      - key: SDK_TOOLKIT_NAME
        value: $.name

# RCA pipeline for failure analysis
composable_pipelines:
  - file: ../../composable/rca_negative_test.yaml
    env:
      SUITE_NAME: github_toolkit_negative_validation
      RCA_MODEL: ${RCA_MODEL:gpt-5-mini}
      SDK_TOOLKIT_ID: ${SDK_TOOLKIT_ID}
      SDK_TOOLKIT_NAME: ${SDK_TOOLKIT_NAME:sdk-analysis-validation}
    save_to_env:
      - key: RCA_PIPELINE_ID
        value: $.id

execution:
  test_directory: tests/validation
  order:
    - test_neg_14_*.yaml
    - test_neg_15_*.yaml
    - test_neg_16_*.yaml
    - test_neg_17_*.yaml
    - test_neg_18_*.yaml
    # update_file validation tests
    - test_neg_30_*.yaml  # Missing OLD marker
    - test_neg_31_*.yaml  # Missing NEW marker
    - test_neg_32_*.yaml  # OLD content not found
    - test_neg_33_*.yaml  # Empty query
    - test_neg_34_*.yaml  # No newline in query

  substitutions:
    GITHUB_TOOLKIT_ID: ${GITHUB_TOOLKIT_ID}
    GITHUB_TOOLKIT_NAME: ${GITHUB_TOOLKIT_NAME}

  settings:
    timeout: 60
    parallel: 1
    stop_on_failure: false

cleanup:
  - name: Delete Test Pipelines
    type: pipeline
    config:
      pattern: "NEG*"
    continue_on_error: true

  - name: Delete RCA Pipeline
    type: pipeline
    config:
      pattern: "RCA-Negative-*"
    continue_on_error: true

  - name: Delete Test Toolkit
    type: toolkit
    config:
      toolkit_id: ${GITHUB_TOOLKIT_ID}
    continue_on_error: true

  - name: Delete SDK Analysis Toolkit
    type: toolkit
    config:
      toolkit_id: ${SDK_TOOLKIT_ID}
    continue_on_error: true

# RCA hook for failed tests
hooks:
  post_test:
    - name: rca_validation_failure
      pipeline_id: ${RCA_PIPELINE_ID}
      condition: "result.get('test_passed') is False"
      input_mapping:
        failure_details: |
          f"""## Validation Test Failure

          **Test Name:** {result.get('pipeline_name', 'Unknown')}
          **Category:** Input Validation Error Handling

          ## Error Quality Analysis
          {result.get('output', {}).get('result', {}).get('error_quality', {})}

          ## Actual Response
          ```
          {result.get('output', {}).get('result', {}).get('actual_response', 'N/A')}
          ```

          ## Improvements Needed
          {result.get('output', {}).get('result', {}).get('improvement_needed', [])}

          Find the validation code in alita_sdk/tools/github/ and suggest improvements.
          """
      output_mapping:
        "result['rca']": "rca_result"
        "result['rca_summary']": "rca_summary"

metadata:
  category: validation
  parent_suite: github_toolkit_negative
