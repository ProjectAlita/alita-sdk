name: "ADO16 - create_branch: Create new branch successfully"
description: |
  Verify the ADO 'create_branch' tool creates a new branch from main.

  Objective: Test happy path for branch creation

  Expected Behavior:
  - Tool executes successfully
  - New branch is created with specified name
  - Returns confirmation with branch details

toolkits:
  - id: ${ADO_REPOS_TOOLKIT_ID}
    name: ${ADO_REPOS_TOOLKIT_NAME}

state:
  branch_name:
    type: str
    value: "test-branch-${TIMESTAMP}"
  success_indicators:
    type: list
    value: ["created", "success", "refs/heads"]
  tool_result:
    type: str
  verification_result:
    type: str
  test_results:
    type: dict

entry_point: invoke_create_branch
nodes:
  - id: invoke_create_branch
    type: toolkit
    input:
      - branch_name
    input_mapping:
      branch_name:
        type: variable
        value: branch_name
    output:
      - tool_result
    structured_output: true
    tool: create_branch
    toolkit_name: ${ADO_REPOS_TOOLKIT_NAME}
    transition: verify_branch_exists

  - id: verify_branch_exists
    type: toolkit
    input: []
    input_mapping: {}
    output:
      - verification_result
    structured_output: true
    tool: list_branches_in_repo
    toolkit_name: ${ADO_REPOS_TOOLKIT_NAME}
    transition: validate_results

  - id: validate_results
    type: llm
    input:
      - tool_result
      - verification_result
      - branch_name
      - success_indicators
    input_mapping:
      chat_history:
        type: fixed
        value: []
      system:
        type: fixed
        value: You are a strict quality assurance validator. Only return valid JSON.
      task:
        type: fstring
        value: |
          Analyze the output from 'create_branch' AND the verification call.

          Tool Result (create_branch): {tool_result}
          Verification Result (list_branches): {verification_result}
          Expected Branch Name: {branch_name}
          Success Indicators: {success_indicators}

          Validation Criteria (ALL must pass):
          1. tool_executed: create_branch result is not empty/null
          2. success_indicated: create_branch output contains a success indicator
          3. branch_exists_in_list: list_branches output contains '{branch_name}'
          4. no_error: Neither output contains 'error', 'failed', 'already exists'

          Return a JSON object with structure:
          {{
            "test_passed": boolean (true only if ALL criteria pass),
            "tool_executed": boolean,
            "success_indicated": boolean,
            "branch_exists_in_list": boolean,
            "no_error": boolean,
            "error": string | null
          }}

          Return ONLY the JSON object (no markdown or explanation).
    model: gpt-4o
    output:
      - test_results
    structured_output_dict:
      test_results: dict
    transition: END
