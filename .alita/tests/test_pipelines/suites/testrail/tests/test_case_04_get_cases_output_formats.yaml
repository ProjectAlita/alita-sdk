name: "TR04 get cases output formats"
priority: High
description: |
  Verify the get_cases tool supports multiple output formats (csv, markdown).
  
  Objective: Test output format flexibility.
  
  Expected Behavior:
  - Tool executes successfully with csv format
  - Returns test cases in CSV format
  - Data is properly formatted

toolkits:
  - id: ${TESTRAIL_TOOLKIT_ID}
    name: ${TESTRAIL_TOOLKIT_NAME}

state:
  project_id:
    type: str
    value: ${TESTRAIL_PROJECT_ID}
  output_format:
    type: str
    value: "csv"
  tool_result:
    type: dict
  test_results:
    type: dict

entry_point: invoke_get_cases

nodes:
  - id: invoke_get_cases
    type: toolkit
    tool: get_cases
    toolkit_name: ${TESTRAIL_TOOLKIT_NAME}
    input:
      - project_id
      - output_format
    input_mapping:
      project_id:
        type: variable
        value: project_id
      output_format:
        type: variable
        value: output_format
    output:
      - tool_result
    structured_output: true
    transition: validate_result

  - id: validate_result
    type: llm
    model: gpt-4o-2024-11-20
    input:
      - tool_result
    input_mapping:
      system:
        type: fixed
        value: "You are a quality assurance validator."
      task:
        type: fstring
        value: |
          Analyze the tool execution results and determine if the test passed.

          tool executed: get_cases
          results: {tool_result}

          IMPORTANT: The tool_result is a string containing CSV data. The CSV output should have:
          - A header row (e.g., "title,id")
          - Data rows with comma-separated values
          - Newline characters separating rows

          expected behavior:
          - tool executed successfully with csv output format
          - returned test cases in csv format (comma-separated values with header row)
          - data contains test case information (title, id)
          - no errors or exceptions

          Evaluate:
          1. did the tool execute successfully?
          2. are there any errors?
          3. does the output contain CSV formatted data with header row and at least one data row?
          4. does the CSV contain comma-separated values and newlines?

          Return a JSON object with:
          {{
            "test_passed": true/false,
            "summary": "brief description of outcome",
            "error": "error details if failed, null if passed"
          }}

          Return **ONLY** the JSON object. No markdown formatting, no additional text.
      chat_history:
        type: fixed
        value: []
    output:
      - test_results
    structured_output_dict:
      test_results: "dict"
    transition: END
