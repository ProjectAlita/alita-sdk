name: "GH10 - Create PR"
description: "Verify create_pull_request tool creates a PR from feature branch to main"

toolkits:
  - id: ${GITHUB_TOOLKIT_ID}
    name: ${GITHUB_TOOLKIT_NAME}

state:
  input:
    type: str
  messages:
    type: list
  head_branch:
    type: str
    value: "tc-file-ops-2025-12-08"
  base_branch:
    type: str
    value: "main"
  pr_title_prefix:
    type: str
    value: "Pipeline Test PR"
  pr_title:
    type: str
  pr_body:
    type: str
  tool_result:
    type: str
  branch_setup_result:
    type: dict
  created_pr_number:
    type: int
  test_results:
    type: dict

entry_point: invoke_set_branch

nodes:
  - id: invoke_set_branch
    type: toolkit
    tool: set_active_branch
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - head_branch
    input_mapping:
      branch_name:
        type: variable
        value: head_branch
    output:
      - tool_result
    structured_output: true
    transition: prepare_pr

  - id: prepare_pr
    type: code
    code:
      type: fixed
      value: |
        import time

        # Check branch was set
        branch_result = alita_state.get('tool_result')
        head_branch = alita_state.get('head_branch', 'tc-file-ops-2025-12-08')
        branch_set = head_branch in str(branch_result) or 'set to' in str(branch_result).lower() if branch_result else False

        branch_setup_result = {
            "branch_set": branch_set,
            "head_branch": head_branch
        }

        # Generate unique PR title
        pr_title_prefix = alita_state.get('pr_title_prefix', 'Pipeline Test PR')
        timestamp = int(time.time())
        pr_title = f"{pr_title_prefix} - {timestamp}"
        pr_body = f"Automated test PR created by GH10 pipeline at {timestamp}.\n\nThis PR tests the create_pull_request tool functionality."
    input:
      - tool_result
      - head_branch
      - pr_title_prefix
    output:
      - branch_setup_result
      - pr_title
      - pr_body
    structured_output: true
    transition: invoke_create_pr

  - id: invoke_create_pr
    type: toolkit
    tool: create_pull_request
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - pr_title
      - pr_body
      - head_branch
      - base_branch
    input_mapping:
      title:
        type: variable
        value: pr_title
      body:
        type: variable
        value: pr_body
      head:
        type: variable
        value: head_branch
      base:
        type: variable
        value: base_branch
    output:
      - tool_result
    structured_output: true
    transition: process_results

  - id: process_results
    type: code
    code:
      type: fixed
      value: |
        import re

        # Process the result from toolkit node
        create_result = alita_state.get('tool_result')
        pr_title = alita_state.get('pr_title')
        head_branch = alita_state.get('head_branch')
        base_branch = alita_state.get('base_branch')

        tool_executed = create_result is not None
        error_message = None
        pr_number = None
        pr_url = None

        # Extract PR number and URL from result
        if isinstance(create_result, str):
            # Look for PR number
            num_match = re.search(r'PR #(\d+)', create_result)
            if num_match:
                pr_number = int(num_match.group(1))
            # Look for URL
            url_match = re.search(r'(https://github\.com/[^\s]+/pull/\d+)', create_result)
            if url_match:
                pr_url = url_match.group(1)
            # Check for existing PR error
            if 'already exists' in create_result.lower():
                error_message = "PR already exists (not a failure)"
        elif isinstance(create_result, dict):
            pr_number = create_result.get('number')
            pr_url = create_result.get('url') or create_result.get('html_url')

        # Verify PR was created
        pr_created = False
        if create_result:
            result_str = str(create_result).lower()
            pr_created = 'created' in result_str or 'success' in result_str or pr_number is not None

        # PR already exists is also a pass condition
        already_exists = 'already exists' in str(create_result).lower() if create_result else False

        test_results = {
            "test_passed": tool_executed and (pr_created or already_exists),
            "tool_executed": tool_executed,
            "pr_title": pr_title,
            "head_branch": head_branch,
            "base_branch": base_branch,
            "pr_created": pr_created,
            "pr_number": pr_number,
            "pr_url": pr_url,
            "tool_response": str(create_result)[:500] if create_result else None,
            "error": error_message
        }

        created_pr_number = pr_number or 0
        test_results
        # Add results to messages
    input:
      - pr_title
      - head_branch
      - base_branch
      - tool_result
    output:
      - messages
    structured_output: false
    transition: END
