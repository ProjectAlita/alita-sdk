# GitHub Toolkit Test Suite Configuration
# This file defines setup, execution, and cleanup for the test suite
#
# This configuration is toolkit-agnostic - all specificity comes from
# the config values, not hardcoded handlers in setup.py/cleanup.py

name: github_toolkit
description: GitHub toolkit integration tests

# Environment variable mappings
# These map .env variables to config values used in setup
env_mapping:
  toolkit_config: ${GIT_CONFIG_PATH:../../../tool_configs/git-config.json}
  access_token: ${GIT_TOOL_ACCESS_TOKEN}
  repository: ${GITHUB_TEST_REPO:ProjectAlita/elitea-testing}
  base_branch: ${GITHUB_BASE_BRANCH:main}

# Setup steps executed before running tests
# Steps are executed in order; if a step fails, setup stops
setup:
  # Step 1: Ensure GitHub credentials configuration exists
  - name: Setup GitHub Configuration
    type: configuration
    config:
      config_type: github
      alita_title: ${GITHUB_SECRET_NAME:github}
      data:
        access_token: ${GIT_TOOL_ACCESS_TOKEN}
        base_url: "https://api.github.com"

  # Step 2: Create or update the GitHub toolkit on the platform
  - name: Create GitHub Toolkit
    type: toolkit
    action: create_or_update
    config:
      # Load base config from shared git-config.json
      config_file: ../configs/git-config.json
      toolkit_type: github
      # Override/substitute values from environment
      overrides:
        # Credentials must use secret reference format (platform requirement)
        github_configuration:
          private: true
          alita_title: ${GITHUB_SECRET_NAME:github}
        repository: ${GITHUB_TEST_REPO:ProjectAlita/elitea-testing}
        active_branch: ${GITHUB_BASE_BRANCH:main}
        base_branch: ${GITHUB_BASE_BRANCH:main}
      # Name for the toolkit on platform
      toolkit_name: ${GITHUB_TOOLKIT_NAME:testing}
    # Save created toolkit ID to environment for pipeline substitution
    save_to_env:
      - key: GITHUB_TOOLKIT_ID
        value: $.id
      - key: GITHUB_TOOLKIT_NAME
        value: $.name

  # Step 3: Create a test branch for write operations
  - name: Create Test Branch
    type: toolkit_invoke
    enabled: true
    config:
      toolkit_id: ${GITHUB_TOOLKIT_ID}
      tool_name: create_branch
      tool_params:
        branch_name: tc-test-${TIMESTAMP}
        from_branch: ${GITHUB_BASE_BRANCH:main}
    continue_on_error: true  # Branch may already exist
    save_to_env:
      - key: GITHUB_TEST_BRANCH
        value: $.result.branch_name

  # Step 4: Create test issue for read tests
  - name: Create Test Issue
    type: toolkit_invoke
    enabled: true
    config:
      toolkit_id: ${GITHUB_TOOLKIT_ID}
      tool_name: create_issue
      tool_params:
        title: "[Test] Automated Test Issue"
        body: |
          This issue is used for automated testing of the GitHub toolkit.
          Do not close or delete this issue.
        labels: "test,automated"
    continue_on_error: true  # Issue may already exist
    save_to_env:
      - key: GITHUB_TEST_ISSUE_NUMBER
        value: $.result.number

  # Step 5: Create SDK analysis toolkit for RCA pipeline
  # This toolkit points to alita-sdk repo so RCA can search/read code
  - name: Create SDK Analysis Toolkit
    type: toolkit
    action: create_or_update
    config:
      config_file: ../configs/git-config.json
      toolkit_type: github
      overrides:
        github_configuration:
          private: true
          alita_title: ${GITHUB_SECRET_NAME:github}
        repository: ${SDK_REPO:ProjectAlita/alita-sdk}
        active_branch: ${SDK_BRANCH:main}
        base_branch: ${SDK_BRANCH:main}
      toolkit_name: sdk-analysis
    save_to_env:
      - key: SDK_TOOLKIT_ID
        value: $.id
      - key: SDK_TOOLKIT_NAME
        value: $.name

# Composable pipelines - seeded first, used by hooks and other pipelines
# These are reusable pipeline components that can be invoked conditionally
composable_pipelines:
  # RCA (Root Cause Analysis) pipeline - invoked when tests fail
  - file: ../composable/rca_on_failure.yaml
    env:
      SUITE_NAME: github_toolkit
      RCA_MODEL: ${RCA_MODEL:gpt-5-mini}
      # Pass SDK toolkit ID so RCA can search/read code
      SDK_TOOLKIT_ID: ${SDK_TOOLKIT_ID}
      SDK_TOOLKIT_NAME: ${SDK_TOOLKIT_NAME:sdk-analysis}
    save_to_env:
      - key: RCA_PIPELINE_ID
        value: $.id
      - key: RCA_PIPELINE_VERSION_ID
        value: $.versions.0.id

# Test execution configuration
execution:
  # Order of test execution (by file pattern or explicit list)
  # Tests are located in tests/ subdirectory
  test_directory: tests
  order:
    - test_case_01_*.yaml  # GH01 - List Branches
    - test_case_02_*.yaml  # GH02 - File Reading Workflow
    - test_case_03_*.yaml  # GH03 - Issue Workflow
    - test_case_04_*.yaml  # GH04 - Commits Workflow
    - test_case_05_*.yaml  # GH05 - List Pull Requests
    - test_case_06_*.yaml  # GH06 - File Operations Workflow
    - test_case_07_*.yaml  # GH07 - Pull Request Workflow
    - test_case_08_*.yaml  # GH08 - Update File Tests (7 scenarios)
    - test_case_09_*.yaml  # GH09 - Search Issues
    - test_case_10_*.yaml  # GH10 - Generic API Call
    - test_case_11_*.yaml  # GH11 - Project Issue Workflow

  # Variables to substitute in test YAML files
  substitutions:
    GITHUB_TOOLKIT_ID: ${GITHUB_TOOLKIT_ID}
    GITHUB_TOOLKIT_NAME: ${GITHUB_TOOLKIT_NAME}
    GITHUB_TEST_BRANCH: ${GITHUB_TEST_BRANCH}
    GITHUB_TEST_ISSUE_NUMBER: ${GITHUB_TEST_ISSUE_NUMBER}

  # Execution settings
  settings:
    timeout: 120
    parallel: 1  # Sequential for dependent tests
    stop_on_failure: false

# Cleanup steps executed after tests complete
# Steps are executed in order; failures are logged but don't stop cleanup
cleanup:
  # Step 1: Delete test branches created during tests
  # Note: This requires a delete_branch tool in the toolkit
  - name: Delete Test Branch
    type: toolkit_invoke
    config:
      toolkit_id: ${GITHUB_TOOLKIT_ID}
      tool_name: delete_branch
      tool_params:
        branch_name: ${GITHUB_TEST_BRANCH}
    continue_on_error: true

  # Step 2: Close test PRs
  # Note: This requires close_pull_request tool in the toolkit
  - name: Close Test Pull Requests
    type: toolkit_invoke
    enabled: false  # Enable if close_pull_request tool is available
    config:
      toolkit_id: ${GITHUB_TOOLKIT_ID}
      tool_name: close_pull_request
      tool_params:
        state: closed
    continue_on_error: true

  # Step 3: Delete seeded pipelines
  - name: Delete Test Pipelines
    type: pipeline
    config:
      pattern: "GH*"  # All GitHub test pipelines
    continue_on_error: true

  # Step 4: Delete the test toolkit
  - name: Delete Test Toolkit
    type: toolkit
    config:
      toolkit_id: ${GITHUB_TOOLKIT_ID}
    enabled: true
    continue_on_error: true

  # Step 5: Delete the SDK analysis toolkit (used by RCA)
  - name: Delete SDK Analysis Toolkit
    type: toolkit
    config:
      toolkit_id: ${SDK_TOOLKIT_ID}
    enabled: true
    continue_on_error: true

# Hooks for custom actions
hooks:
  # Run before any setup steps
  pre_setup: []

  # Run after all setup steps complete
  post_setup: []

  # Run after each test - e.g., RCA on failure
  post_test:
    # Root Cause Analysis hook - invoked when a test fails
    - name: rca_on_failure
      pipeline_id: ${RCA_PIPELINE_ID}
      # Condition: only run if test failed
      condition: "result.get('test_passed') is False"
      # Map test result to state variable
      input_mapping:
        failure_details: |
          f"""**Test Name:** {result.get('pipeline_name', 'Unknown')}
          **Toolkit:** github
          **Status:** Test Failed

          **Error Message:**
          {result.get('error') or result.get('output', {}).get('result', {}).get('error', 'No error message')}

          **Pipeline ID:** {result.get('pipeline_id', 'N/A')}
          **Version ID:** {result.get('version_id', 'N/A')}
          **Execution Time:** {result.get('execution_time', 'N/A')}s

          **Test Output Details:**
          - Test passed: {result.get('test_passed', False)}
          - Tool executed: {result.get('output', {}).get('result', {}).get('tool_executed', 'N/A')}
          - Error: {result.get('output', {}).get('result', {}).get('error', 'None')}
          """
      # Map pipeline output back to test result
      output_mapping:
        "result['rca']": "rca_result"
        "result['rca_summary']": "rca_summary"

  # Run before cleanup starts
  pre_cleanup: []

  # Run after cleanup completes
  post_cleanup: []
