name: "GH15 - Delete File"
description: "Verify delete_file tool removes a file from the repository branch"

toolkits:
  - id: ${GITHUB_TOOLKIT_ID}
    name: ${GITHUB_TOOLKIT_NAME}

state:
  input:
    type: str
  messages:
    type: list
  target_branch:
    type: str
    value: "testdata-TC-052-read-multiple-files"
  file_path:
    type: str
  file_contents:
    type: str
  tool_result:
    type: str
  test_results:
    type: dict

entry_point: set_branch

nodes:
  - id: set_branch
    type: toolkit
    tool: set_active_branch
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - target_branch
    input_mapping:
      branch_name:
        type: variable
        value: target_branch
    output:
      - tool_result
    structured_output: true
    transition: prepare_file

  - id: prepare_file
    type: code
    code:
      type: fixed
      value: |
        import time
        import random
        import string

        # Generate unique file name for deletion test
        timestamp = time.strftime('%Y%m%d-%H%M%S')
        random_suffix = ''.join(random.choices(string.ascii_lowercase + string.digits, k=6))
        file_path = f"test-data/temp/delete-test-{timestamp}-{random_suffix}.txt"
        file_contents = f"Temporary file for delete test - {timestamp}"

        {"file_path": file_path, "file_contents": file_contents}
    input: []
    output:
      - file_path
      - file_contents
    structured_output: true
    transition: create_file

  - id: create_file
    type: toolkit
    tool: create_file
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - file_path
      - file_contents
    input_mapping:
      file_path:
        type: variable
        value: file_path
      file_contents:
        type: variable
        value: file_contents
    output:
      - tool_result
    structured_output: true
    transition: delete_file

  - id: delete_file
    type: toolkit
    tool: delete_file
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - file_path
    input_mapping:
      file_path:
        type: variable
        value: file_path
    output:
      - tool_result
    structured_output: true
    transition: verify_deletion

  - id: verify_deletion
    type: toolkit
    tool: read_file
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - file_path
    input_mapping:
      file_path:
        type: variable
        value: file_path
    output:
      - tool_result
    structured_output: true
    transition: process_results

  - id: process_results
    type: code
    code:
      type: fixed
      value: |
        # Process the result
        read_result = alita_state.get('tool_result')
        file_path = alita_state.get('file_path')

        tool_executed = True
        error_message = None

        # Check if file is deleted (read should fail or return error/not found)
        read_result_str = str(read_result).lower() if read_result else ''
        file_deleted = 'not found' in read_result_str or '404' in read_result_str or 'error' in read_result_str or read_result is None

        test_results = {
            "test_passed": file_deleted,
            "tool_executed": tool_executed,
            "file_path": file_path,
            "file_deleted": file_deleted,
            "verification_response": str(read_result)[:300] if read_result else "None/Empty",
            "error": error_message
        }
        test_results
    input:
      - tool_result
      - file_path
    output:
      - messages
    structured_output: false
    transition: END
