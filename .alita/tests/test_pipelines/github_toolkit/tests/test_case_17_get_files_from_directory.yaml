name: "GH17 - Get Files from Directory"
description: "Verify get_files_from_directory tool returns files from a specific directory"

toolkits:
  - id: ${GITHUB_TOOLKIT_ID}
    name: ${GITHUB_TOOLKIT_NAME}

state:
  input:
    type: str
  messages:
    type: list
  directory_path:
    type: str
    value: "ui-tests"
  tool_result:
    type: str
  test_results:
    type: dict

entry_point: invoke_get_files

nodes:
  - id: invoke_get_files
    type: toolkit
    tool: get_files_from_directory
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - directory_path
    input_mapping:
      directory_path:
        type: variable
        value: directory_path
    output:
      - tool_result
    structured_output: true
    transition: process_results

  - id: process_results
    type: code
    code:
      type: fixed
      value: |
        # Process the result from toolkit node
        files_result = alita_state.get('tool_result')
        directory_path = alita_state.get('directory_path', 'ui-tests')

        tool_executed = files_result is not None
        error_message = None
        files_list = []

        try:
            # Parse result
            if isinstance(files_result, list):
                files_list = files_result
            elif isinstance(files_result, str):
                import json
                try:
                    files_list = json.loads(files_result)
                except:
                    files_list = [f.strip() for f in files_result.split('\n') if f.strip()]
        except Exception as e:
            error_message = str(e)

        # Extract file paths (handle both string list and dict list)
        file_paths = []
        for f in files_list:
            if isinstance(f, dict):
                file_paths.append(f.get('path') or f.get('name', ''))
            else:
                file_paths.append(str(f))

        has_files = len(file_paths) > 0

        # Check for expected contents (README.md, components)
        has_readme = any('README' in f.upper() for f in file_paths)
        has_components = any('component' in f.lower() for f in file_paths)

        test_results = {
            "test_passed": tool_executed and has_files,
            "tool_executed": tool_executed,
            "directory_path": directory_path,
            "files_count": len(file_paths),
            "has_files": has_files,
            "has_readme": has_readme,
            "has_components": has_components,
            "files_sample": file_paths[:15],
            "error": error_message
        }
        test_results
    input:
      - directory_path
      - tool_result
    output:
      - messages
    structured_output: false
    transition: END
