name: "GH13 - Comment on Issue"
description: "Verify comment_on_issue tool adds a comment to an existing issue"

toolkits:
  - id: ${GITHUB_TOOLKIT_ID}
    name: ${GITHUB_TOOLKIT_NAME}

state:
  input:
    type: str
  messages:
    type: list
  issue_number:
    type: str
    value: "15"
  comment_text:
    type: str
  tool_result:
    type: str
  test_results:
    type: dict

entry_point: prepare_comment

nodes:
  - id: prepare_comment
    type: code
    code:
      type: fixed
      value: |
        import time
        import random
        import string

        # Generate unique comment text with timestamp
        timestamp = time.strftime('%Y-%m-%d %H:%M:%S')
        random_id = ''.join(random.choices(string.ascii_lowercase + string.digits, k=6))
        comment_text = f"AI test comment {random_id} at {timestamp} - Pipeline test GH13"

        {"comment_text": comment_text}
    input: []
    output:
      - comment_text
    structured_output: true
    transition: invoke_comment

  - id: invoke_comment
    type: toolkit
    tool: comment_on_issue
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - issue_number
      - comment_text
    input_mapping:
      issue_number:
        type: variable
        value: issue_number
      comment:
        type: variable
        value: comment_text
    output:
      - tool_result
    structured_output: true
    transition: process_results

  - id: process_results
    type: code
    code:
      type: fixed
      value: |
        # Process the result from toolkit node
        comment_result = alita_state.get('tool_result')
        issue_number = alita_state.get('issue_number', 15)
        comment_text = alita_state.get('comment_text', '')

        tool_executed = comment_result is not None
        error_message = None
        result_str = str(comment_result).lower() if comment_result else ''

        # Verify success indicators
        comment_added = 'success' in result_str or 'added' in result_str or 'created' in result_str
        has_url = 'github.com' in result_str or 'issuecomment' in result_str or 'http' in result_str

        # Extract URL if present
        comment_url = None
        if comment_result:
            result_full = str(comment_result)
            import re
            urls = re.findall(r'https?://[^\s\'"]+', result_full)
            comment_url = urls[0] if urls else None

        test_results = {
            "test_passed": tool_executed and (comment_added or has_url),
            "tool_executed": tool_executed,
            "issue_number": issue_number,
            "comment_text_preview": comment_text[:50] if comment_text else None,
            "comment_added": comment_added,
            "has_url": has_url,
            "comment_url": comment_url,
            "tool_response": str(comment_result)[:300] if comment_result else None,
            "error": error_message
        }
        test_results
    input:
      - issue_number
      - comment_text
      - tool_result
    output:
      - messages
    structured_output: false
    transition: END
