name: "GH25 - Search Project Issues"
description: "Verify search_project_issues tool filters items by query on a GitHub project board"

toolkits:
  - id: ${GITHUB_TOOLKIT_ID}
    name: ${GITHUB_TOOLKIT_NAME}

state:
  input:
    type: str
  messages:
    type: list
  board_repo:
    type: str
    value: "ProjectAlita/elitea-testing"
  project_number:
    type: int
    value: 11
  search_query:
    type: str
    value: "status:Done"
  items_count:
    type: int
    value: 3
  tool_result:
    type: str
  test_results:
    type: dict

entry_point: invoke_search

nodes:
  - id: invoke_search
    type: toolkit
    tool: search_project_issues
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - board_repo
      - project_number
      - search_query
      - items_count
    input_mapping:
      board_repo:
        type: variable
        value: board_repo
      project_number:
        type: variable
        value: project_number
      search_query:
        type: variable
        value: search_query
      items_count:
        type: variable
        value: items_count
    output:
      - tool_result
    structured_output: true
    transition: process_results

  - id: process_results
    type: code
    code:
      type: fixed
      value: |
        # Process the result
        search_result = alita_state.get('tool_result')
        search_query = alita_state.get('search_query', 'status:Done')
        items_count = alita_state.get('items_count', 3)

        tool_executed = search_result is not None
        error_message = None
        project_data = {}

        try:
            if isinstance(search_result, dict):
                project_data = search_result
            elif isinstance(search_result, str):
                import json
                try:
                    project_data = json.loads(search_result)
                except:
                    project_data = {'raw': search_result}
        except Exception as e:
            error_message = str(e)

        # Check for expected fields
        has_id = 'id' in project_data
        has_title = 'title' in project_data
        has_items = 'items' in project_data
        has_fields = 'fields' in project_data

        # Get items info
        items = project_data.get('items', [])
        items_returned = len(items) if isinstance(items, list) else 0

        # Check for Status field
        fields = project_data.get('fields', [])
        has_status_field = any(f.get('name') == 'Status' for f in fields) if isinstance(fields, list) else False

        # Extract sample items
        items_sample = []
        for item in (items[:3] if isinstance(items, list) else []):
            if isinstance(item, dict):
                content = item.get('content', {})
                field_values = item.get('fieldValues', {})
                items_sample.append({
                    "id": item.get('id'),
                    "type": item.get('type'),
                    "title": content.get('title', '')[:50] if isinstance(content, dict) else None,
                    "status": field_values.get('Status') if isinstance(field_values, dict) else None
                })

        test_results = {
            "test_passed": tool_executed and (has_items or has_id),
            "tool_executed": tool_executed,
            "search_query": search_query,
            "items_requested": items_count,
            "items_returned": items_returned,
            "project_info": {
                "id": project_data.get('id'),
                "title": project_data.get('title')
            },
            "has_status_field": has_status_field,
            "items_sample": items_sample,
            "structure_check": {
                "has_id": has_id,
                "has_title": has_title,
                "has_items": has_items,
                "has_fields": has_fields
            },
            "error": error_message
        }
        test_results
    input:
      - search_query
      - items_count
      - tool_result
    output:
      - messages
    structured_output: false
    transition: END
