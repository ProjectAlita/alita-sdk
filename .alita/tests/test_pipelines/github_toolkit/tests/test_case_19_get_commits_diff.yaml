name: "GH19 - Get Commits Diff"
description: "Verify get_commits_diff tool compares two commits and returns diff summary"

toolkits:
  - id: ${GITHUB_TOOLKIT_ID}
    name: ${GITHUB_TOOLKIT_NAME}

state:
  input:
    type: str
  messages:
    type: list
  base_sha:
    type: str
    value: "main"
  head_sha:
    type: str
    value: "tc-file-ops-2025-12-08"
  tool_result:
    type: str
  test_results:
    type: dict

entry_point: invoke_diff

nodes:
  - id: invoke_diff
    type: toolkit
    tool: get_commits_diff
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - base_sha
      - head_sha
    input_mapping:
      base_sha:
        type: variable
        value: base_sha
      head_sha:
        type: variable
        value: head_sha
    output:
      - tool_result
    structured_output: true
    transition: process_results

  - id: process_results
    type: code
    code:
      type: fixed
      value: |
        # Process the result from toolkit node
        diff_result = alita_state.get('tool_result')
        base_sha = alita_state.get('base_sha', 'main')
        head_sha = alita_state.get('head_sha', 'tc-file-ops-2025-12-08')

        tool_executed = diff_result is not None
        error_message = None
        diff_data = {}

        try:
            # Parse result
            if isinstance(diff_result, dict):
                diff_data = diff_result
            elif isinstance(diff_result, str):
                import json
                try:
                    diff_data = json.loads(diff_result)
                except:
                    diff_data = {'raw': diff_result}
        except Exception as e:
            error_message = str(e)

        # Check for expected fields
        has_status = 'status' in diff_data
        has_ahead_by = 'ahead_by' in diff_data
        has_behind_by = 'behind_by' in diff_data
        has_total_commits = 'total_commits' in diff_data
        has_files = 'files' in diff_data

        # Get files info
        files = diff_data.get('files', [])
        files_count = len(files) if isinstance(files, list) else 0

        test_results = {
            "test_passed": tool_executed and (has_status or has_files or 'commit' in str(diff_data).lower()),
            "tool_executed": tool_executed,
            "base_sha": base_sha,
            "head_sha": head_sha,
            "diff_summary": {
                "status": diff_data.get('status'),
                "ahead_by": diff_data.get('ahead_by'),
                "behind_by": diff_data.get('behind_by'),
                "total_commits": diff_data.get('total_commits'),
                "files_count": files_count
            },
            "structure_check": {
                "has_status": has_status,
                "has_ahead_by": has_ahead_by,
                "has_behind_by": has_behind_by,
                "has_total_commits": has_total_commits,
                "has_files": has_files
            },
            "error": error_message
        }
        test_results
    input:
      - base_sha
      - head_sha
      - tool_result
    output:
      - messages
    structured_output: false
    transition: END
