name: "GH11b - Issue Workflow"
description: "Test regular issue operations: create_issue, get_issue, update_issue, comment_on_issue, close_issue"

toolkits:
  - id: ${GITHUB_TOOLKIT_ID}
    name: ${GITHUB_TOOLKIT_NAME}

state:
  input:
    type: str
  messages:
    type: list
  issue_title:
    type: str
  issue_body:
    type: str
  issue_number:
    type: str
  updated_title:
    type: str
  updated_body:
    type: str
  comment_text:
    type: str
  tool_result:
    type: str
  get_result:
    type: str
  update_result:
    type: str
  comment_result:
    type: str
  validation_results:
    type: dict
  test_results:
    type: dict

entry_point: prepare_issue

nodes:
  # Step 1: Prepare unique issue data
  - id: prepare_issue
    type: code
    code:
      type: fixed
      value: |
        import time
        import random
        import string

        # Generate unique identifiers
        timestamp = time.strftime('%Y%m%d-%H%M%S')
        random_id = ''.join(random.choices(string.ascii_lowercase + string.digits, k=6))

        # Issue details
        issue_title = f"GH11b-Issue-Test-{random_id}"
        nl = chr(10)
        issue_body = "Automated test issue for GH11b Issue Workflow." + nl + nl + "**Created:** " + timestamp + nl + "**ID:** " + random_id + nl + nl + "This issue will be retrieved, updated, commented, and closed."

        {"issue_title": issue_title, "issue_body": issue_body}
    input: []
    output:
      - issue_title
      - issue_body
    structured_output: true
    transition: create_issue

  # Step 2: Create regular issue
  - id: create_issue
    type: toolkit
    tool: create_issue
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - issue_title
      - issue_body
    input_mapping:
      title:
        type: variable
        value: issue_title
      body:
        type: variable
        value: issue_body
    output:
      - tool_result
    structured_output: true
    transition: extract_issue_number

  # Step 3: Extract issue number from create response
  - id: extract_issue_number
    type: code
    code:
      type: fixed
      value: |
        import re

        create_result = alita_state.get('tool_result')
        result_str = str(create_result) if create_result else ''

        # Extract issue number
        issue_number = None
        # Try pattern: number '74' or number "74" or number 74
        numbers = re.findall(r"number\s*['\"]?(\d+)['\"]?", result_str, re.IGNORECASE)
        if numbers:
            issue_number = numbers[0]
        else:
            # Try #123 pattern
            numbers = re.findall(r'#(\d+)', result_str)
            if numbers:
                issue_number = numbers[0]

        # Check if create succeeded
        result_lower = result_str.lower()
        create_ok = 'issue with number' in result_lower or 'created' in result_lower or 'success' in result_lower

        validation_results = {
            "create_issue_ok": create_ok and issue_number is not None,
            "issue_number": issue_number
        }

        {"issue_number": issue_number, "validation_results": validation_results}
    input:
      - tool_result
    output:
      - issue_number
      - validation_results
    structured_output: true
    transition: get_issue

  # Step 4: Get the created issue
  - id: get_issue
    type: toolkit
    tool: get_issue
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - issue_number
    input_mapping:
      issue_id:
        type: variable
        value: issue_number
    output:
      - get_result
    structured_output: true
    transition: validate_get

  # Step 5: Validate get issue succeeded
  - id: validate_get
    type: code
    code:
      type: fixed
      value: |
        import json

        get_result = alita_state.get('get_result')
        issue_title = alita_state.get('issue_title', '')
        issue_number = alita_state.get('issue_number', '')
        validation_results = alita_state.get('validation_results', {})

        # Parse get result
        get_str = str(get_result).lower() if get_result else ''

        # Check if our issue is in the results
        issue_found = False
        if issue_title:
            issue_found = issue_title.lower() in get_str
        if not issue_found and issue_number:
            issue_found = str(issue_number) in get_str

        get_ok = issue_found or 'title' in get_str or 'body' in get_str or 'state' in get_str

        validation_results['get_issue_ok'] = get_ok
        validation_results['issue_found'] = issue_found

        {"validation_results": validation_results}
    input:
      - get_result
      - issue_title
      - issue_number
      - validation_results
    output:
      - validation_results
    structured_output: true
    transition: prepare_update

  # Step 6: Prepare update data
  - id: prepare_update
    type: code
    code:
      type: fixed
      value: |
        import time
        import random
        import string

        timestamp = time.strftime('%Y-%m-%d %H:%M:%S')
        random_id = ''.join(random.choices(string.ascii_lowercase + string.digits, k=4))

        nl = chr(10)
        updated_title = alita_state.get('issue_title', '') + f"-UPDATED-{random_id}"
        updated_body = "Issue updated by GH11b workflow at " + timestamp + "." + nl + nl + "Update ID: " + random_id

        {"updated_title": updated_title, "updated_body": updated_body}
    input:
      - issue_title
    output:
      - updated_title
      - updated_body
    structured_output: true
    transition: update_issue

  # Step 7: Update the issue
  - id: update_issue
    type: toolkit
    tool: update_issue
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - issue_number
      - updated_title
      - updated_body
    input_mapping:
      issue_id:
        type: variable
        value: issue_number
      title:
        type: variable
        value: updated_title
      body:
        type: variable
        value: updated_body
    output:
      - update_result
    structured_output: true
    transition: validate_update

  # Step 8: Validate update and prepare comment
  - id: validate_update
    type: code
    code:
      type: fixed
      value: |
        import time
        import random
        import string

        update_result = alita_state.get('update_result')
        validation_results = alita_state.get('validation_results', {})

        update_str = str(update_result).lower() if update_result else ''
        update_ok = 'updated' in update_str or 'success' in update_str or 'issue' in update_str

        validation_results['update_issue_ok'] = update_ok

        # Prepare comment
        timestamp = time.strftime('%Y-%m-%d %H:%M:%S')
        random_id = ''.join(random.choices(string.ascii_lowercase + string.digits, k=4))
        nl = chr(10)
        comment_text = "## GH11b Workflow Comment" + nl + nl + "This comment was added by the automated test workflow." + nl + nl + "**Timestamp:** " + timestamp + nl + "**Comment ID:** " + random_id

        {"validation_results": validation_results, "comment_text": comment_text}
    input:
      - update_result
      - validation_results
    output:
      - validation_results
      - comment_text
    structured_output: true
    transition: comment_on_issue

  # Step 9: Add comment to the issue
  - id: comment_on_issue
    type: toolkit
    tool: comment_on_issue
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - issue_number
      - comment_text
    input_mapping:
      issue_number:
        type: variable
        value: issue_number
      comment:
        type: variable
        value: comment_text
    output:
      - comment_result
    structured_output: true
    transition: validate_comment

  # Step 10: Validate comment succeeded
  - id: validate_comment
    type: code
    code:
      type: fixed
      value: |
        comment_result = alita_state.get('comment_result')
        validation_results = alita_state.get('validation_results', {})

        comment_str = str(comment_result).lower() if comment_result else ''
        comment_ok = 'success' in comment_str or 'added' in comment_str or 'created' in comment_str or 'http' in comment_str

        validation_results['comment_on_issue_ok'] = comment_ok

        {"validation_results": validation_results}
    input:
      - comment_result
      - validation_results
    output:
      - validation_results
    structured_output: true
    transition: close_issue

  # Step 11: Close the issue
  - id: close_issue
    type: toolkit
    tool: update_issue
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - issue_number
    input_mapping:
      issue_id:
        type: variable
        value: issue_number
      state:
        type: fixed
        value: "closed"
    output:
      - tool_result
    structured_output: true
    transition: process_results

  # Step 12: Process final results
  - id: process_results
    type: code
    code:
      type: fixed
      value: |
        close_result = alita_state.get('tool_result')
        issue_number = alita_state.get('issue_number')
        issue_title = alita_state.get('issue_title')
        validation_results = alita_state.get('validation_results', {})

        close_str = str(close_result).lower() if close_result else ''
        close_ok = 'closed' in close_str or 'updated' in close_str or 'success' in close_str

        validation_results['close_issue_ok'] = close_ok

        # Overall test pass
        create_ok = validation_results.get('create_issue_ok', False)
        get_ok = validation_results.get('get_issue_ok', False)
        update_ok = validation_results.get('update_issue_ok', False)
        comment_ok = validation_results.get('comment_on_issue_ok', False)

        # Core operations must pass
        all_ok = create_ok and get_ok and update_ok and comment_ok and close_ok

        test_results = {
            "test_passed": all_ok,
            "operations": {
                "create_issue": create_ok,
                "get_issue": get_ok,
                "update_issue": update_ok,
                "comment_on_issue": comment_ok,
                "close_issue": close_ok
            },
            "details": {
                "issue_number": issue_number,
                "issue_title": issue_title,
                "issue_found": validation_results.get('issue_found', False)
            }
        }
        {"test_results": test_results}
    input:
      - tool_result
      - issue_number
      - issue_title
      - validation_results
    output:
      - test_results
    structured_output: true
    transition: END
