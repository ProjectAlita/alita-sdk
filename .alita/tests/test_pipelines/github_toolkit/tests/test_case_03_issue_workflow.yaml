name: "GH03 - Issue Workflow"
description: "Test issue operations: create issue, list issues, get issue, add various comment types, close issue"

toolkits:
  - id: ${GITHUB_TOOLKIT_ID}
    name: ${GITHUB_TOOLKIT_NAME}

state:
  input:
    type: str
  messages:
    type: list
  issue_title:
    type: str
  issue_body:
    type: str
  issue_number:
    type: str
  tool_result:
    type: str
  issues_list:
    type: str
  issue_details:
    type: str
  plain_comment:
    type: str
  code_comment:
    type: str
  markdown_comment:
    type: str
  validation_results:
    type: dict
  test_results:
    type: dict

entry_point: prepare_test_data

nodes:
  # Step 1: Prepare test data using LLM
  - id: prepare_test_data
    type: llm
    model: gpt-4o
    input_mapping:
      system:
        type: fixed
        value: "You are a test data generator for software testing."
      task:
        type: fixed
        value: |
          Generate test data for a GitHub issue workflow test.
          
          I need the following strings generated:
          1. issue_title: A unique title like "[Test] GH3 Issue Workflow - {Timestamp} - {RandomID}"
          2. issue_body: A comprehensive body text explaining this is an automated test.
          3. plain_comment: A simple plain text comment string.
          4. code_comment: A comment string containing a Python code block and a JavaScript code block.
          5. markdown_comment: A comment string containing a Markdown table and a checklist.
          
          Make them realistic and varied.
      chat_history:
        type: fixed
        value: []
    output:
      - issue_title
      - issue_body
      - plain_comment
      - code_comment
      - markdown_comment
    structured_output: true
    structured_output_dict:
       issue_title: "str"
       issue_body: "str"
       plain_comment: "str"
       code_comment: "str"
       markdown_comment: "str"
    transition: create_issue

  # Step 2: Create the test issue
  - id: create_issue
    type: toolkit
    tool: create_issue
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - issue_title
      - issue_body
    input_mapping:
      title:
        type: variable
        value: issue_title
      body:
        type: variable
        value: issue_body
    output:
      - tool_result
    structured_output: true
    transition: extract_issue_number

  # Step 3: Extract issue number using LLM
  - id: extract_issue_number
    type: llm
    model: gpt-4o
    input:
      - tool_result
    input_mapping:
      system:
        type: fixed
        value: "You are a data extractor. Your job is to parse API responses."
      task:
        type: fstring
        value: |
          Analyze the following result from a create_issue operation:
          {tool_result}

          1. Extract the issue number (as a string).
          2. Create a validation_results dictionary with key "issue_created" set to true if the issue number was found, else false.
          
          Return issue_number and validation_results.
      chat_history:
        type: fixed
        value: []
    output:
      - issue_number
      - validation_results
    structured_output: true
    structured_output_dict:
        issue_number: "str"
        validation_results: "dict"
    transition: list_issues

  # Step 4: List issues to verify our issue appears
  - id: list_issues
    type: toolkit
    tool: get_issues
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input: []
    input_mapping:
      state:
        type: fixed
        value: "open"
    output:
      - issues_list
    structured_output: true
    transition: validate_list_issues

  # Step 5: Validate our issue appears in the list using LLM
  - id: validate_list_issues
    type: llm
    model: gpt-4o
    input:
      - issues_list
      - issue_number
      - validation_results
    input_mapping:
      system:
        type: fixed
        value: "You are a test validator."
      task:
        type: fstring
        value: |
          I have a list of issues and an issue number I expect to be in it.
          
          Issue Number: {issue_number}
          Issues List: {issues_list}
          Current Validation Results: {validation_results}
          
          1. Check if the issue_number is present in the issues_list.
          2. Count the number of issues in the list.
          3. Update validation_results with:
             - "issues_listed": true if count > 0
             - "issue_in_list": true if issue_number is found
             - "issues_count": the count of issues
          
          Return the updated validation_results.
      chat_history:
        type: fixed
        value: []
    output:
      - validation_results
    structured_output: true
    structured_output_dict:
        validation_results: "dict"
    transition: get_issue

  # Step 6: Get specific issue to validate details
  - id: get_issue
    type: toolkit
    tool: get_issue
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - issue_number
    input_mapping:
      issue_number:
        type: variable
        value: issue_number
    output:
      - issue_details
    structured_output: true
    transition: validate_get_issue

  # Step 7: Validate get_issue result using LLM
  - id: validate_get_issue
    type: llm
    model: gpt-4o
    input:
      - issue_details
      - issue_number
      - issue_title
      - validation_results
    input_mapping:
      system:
        type: fixed
        value: "You are a test validator."
      task:
        type: fstring
        value: |
          Verify the retrieved issue details match expectations.
          
          Issue Number: {issue_number}
          Expected Title: {issue_title}
          Retrieved Details: {issue_details}
          Current Validation Results: {validation_results}
          
          1. Verify if the retrieved details correspond to the issue number (look for the number in the details).
          2. Verify if the title in details matches (or contains) the expected title.
          3. Update validation_results with:
             - "issue_retrieved": true if verification passes
             - "title_matches": true if title matches
          
          Return the updated validation_results.
      chat_history:
        type: fixed
        value: []
    output:
      - validation_results
    structured_output: true
    structured_output_dict:
        validation_results: "dict"
    transition: add_plain_comment

  # Step 8: Add plain text comment
  - id: add_plain_comment
    type: toolkit
    tool: comment_on_issue
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - issue_number
      - plain_comment
    input_mapping:
      issue_number:
        type: variable
        value: issue_number
      comment:
        type: variable
        value: plain_comment
    output:
      - tool_result
    structured_output: true
    transition: validate_plain_comment

  - id: validate_plain_comment
    type: llm
    model: gpt-4o
    input:
      - tool_result
      - validation_results
    input_mapping:
      system:
        type: fixed
        value: "You are a test validator."
      task:
        type: fstring
        value: |
          Validate if the comment was added successfully based on this tool result:
          {tool_result}
          
          Current Validation Results: {validation_results}
          
          Update validation_results with "comment_plain": true if successful.
          Return updated validation_results.
      chat_history:
        type: fixed
        value: []
    output:
      - validation_results
    structured_output: true
    structured_output_dict:
        validation_results: "dict"
    transition: add_code_comment

  # Step 9: Add code block comment
  - id: add_code_comment
    type: toolkit
    tool: comment_on_issue
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - issue_number
      - code_comment
    input_mapping:
      issue_number:
        type: variable
        value: issue_number
      comment:
        type: variable
        value: code_comment
    output:
      - tool_result
    structured_output: true
    transition: validate_code_comment

  - id: validate_code_comment
    type: llm
    model: gpt-4o
    input:
      - tool_result
      - validation_results
    input_mapping:
      system:
        type: fixed
        value: "You are a test validator."
      task:
        type: fstring
        value: |
          Validate if the code comment was added successfully based on this tool result:
          {tool_result}
          
          Current Validation Results: {validation_results}
          
          Update validation_results with "comment_code": true if successful.
          Return updated validation_results.
      chat_history:
        type: fixed
        value: []
    output:
      - validation_results
    structured_output: true
    structured_output_dict:
        validation_results: "dict"
    transition: add_markdown_comment

  # Step 10: Add markdown comment with table
  - id: add_markdown_comment
    type: toolkit
    tool: comment_on_issue
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - issue_number
      - markdown_comment
    input_mapping:
      issue_number:
        type: variable
        value: issue_number
      comment:
        type: variable
        value: markdown_comment
    output:
      - tool_result
    structured_output: true
    transition: validate_markdown_comment

  - id: validate_markdown_comment
    type: llm
    model: gpt-4o
    input:
      - tool_result
      - validation_results
    input_mapping:
      system:
        type: fixed
        value: "You are a test validator."
      task:
        type: fstring
        value: |
          Validate if the markdown comment was added successfully based on this tool result:
          {tool_result}
          
          Current Validation Results: {validation_results}
          
          Update validation_results with "comment_markdown": true if successful.
          Return updated validation_results.
      chat_history:
        type: fixed
        value: []
    output:
      - validation_results
    structured_output: true
    structured_output_dict:
        validation_results: "dict"
    transition: process_results

  # Step 11: Process and validate all results using LLM
  - id: process_results
    type: llm
    model: gpt-4o
    input:
      - issue_number
      - validation_results
    input_mapping:
      system:
        type: fixed
        value: "You are a quality assurance reporter."
      task:
        type: fstring
        value: |
          Analyze the final validation results for the Issue Workflow test.
          
          Issue Number: {issue_number}
          Validation Results: {validation_results}
          
          Calculate the following statuses based on validation_results:
          - create_issue: result of 'issue_created'
          - list_issues: result of 'issues_listed'
          - get_issue: result of 'issue_retrieved'
          - issues_count: value of 'issues_count' (default 0)
          - plain_text: result of 'comment_plain'
          - code_block: result of 'comment_code'
          - markdown_table: result of 'comment_markdown'
          
          Logic:
          - all_comments_ok = plain_text AND code_block AND markdown_table
          - all_operations_ok = create_issue AND list_issues AND get_issue AND all_comments_ok
          
          Construct a final test_results object strictly following this structure:
          {
              "test_passed": all_operations_ok,
              "issue_number": "{issue_number}",
              "operations": {
                  "create_issue": create_issue,
                  "list_issues": list_issues,
                  "get_issue": get_issue,
                  "issues_count": issues_count
              },
              "comments": {
                  "plain_text": plain_text,
                  "code_block": code_block,
                  "markdown_table": markdown_table,
                  "all_passed": all_comments_ok
              }
          }
          
          Return the test_results object.
      chat_history:
        type: fixed
        value: []
    output:
      - test_results
    structured_output: true
    structured_output_dict:
        test_results: "dict"
    transition: close_issue

  # Step 12: Close the test issue
  - id: close_issue
    type: toolkit
    tool: update_issue
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - issue_number
    input_mapping:
      issue_id:
        type: variable
        value: issue_number
      state:
        type: fixed
        value: "closed"
    output:
      - tool_result
    structured_output: true
    transition: END
