name: "GH03 - Issue Workflow"
description: "Test issue operations: create issue, list issues, get issue, add various comment types, close issue"

toolkits:
  - id: ${GITHUB_TOOLKIT_ID}
    name: ${GITHUB_TOOLKIT_NAME}

state:
  input:
    type: str
  messages:
    type: list
  issue_title:
    type: str
  issue_body:
    type: str
  issue_number:
    type: int
  tool_result:
    type: str
  issues_list:
    type: str
  issue_details:
    type: str
  plain_comment:
    type: str
  code_comment:
    type: str
  markdown_comment:
    type: str
  validation_results:
    type: dict
  test_results:
    type: dict

entry_point: prepare_test_data

nodes:
  # Step 1: Prepare test data
  - id: prepare_test_data
    type: code
    code:
      type: fixed
      value: |
        import time
        import random
        import string

        timestamp = time.strftime('%Y%m%d-%H%M%S')
        random_suffix = ''.join(random.choices(string.ascii_lowercase + string.digits, k=4))

        # Issue details
        issue_title = f"[Test] GH3 Issue Workflow - {timestamp}-{random_suffix}"
        issue_body = (
            f"This is an automated test issue created by the GH3 pipeline.\n\n"
            f"Purpose: Test issue creation, listing, retrieval, and various comment types.\n\n"
            f"- Timestamp: {timestamp}\n"
            f"- Random ID: {random_suffix}\n\n"
            f"This issue will be closed automatically after testing."
        )

        # Different comment types
        plain_comment = f"Plain text comment - Test ID: {random_suffix} at {timestamp}"

        code_comment = (
            f"Here's a code example for testing:\n\n"
            f"```python\n"
            f"def hello_world():\n"
            f"    # Test comment with code block\n"
            f"    print('Hello from GH3 test - {random_suffix}')\n"
            f"    return True\n"
            f"```\n\n"
            f"```javascript\n"
            f"// JavaScript example\n"
            f"const testId = '{random_suffix}';\n"
            f"console.log('Test executed at {timestamp}');\n"
            f"```"
        )

        markdown_comment = (
            f"## Markdown Comment Test\n\n"
            f"This comment tests various markdown features:\n\n"
            f"| Feature | Status | Notes |\n"
            f"|---------|--------|-------|\n"
            f"| Bold | Working | Uses double asterisks |\n"
            f"| Italic | Working | Uses single asterisks |\n"
            f"| Code | inline | Uses backticks |\n\n"
            f"### Checklist\n"
            f"- [x] Create issue\n"
            f"- [x] List issues\n"
            f"- [x] Get issue\n"
            f"- [x] Add plain comment\n"
            f"- [x] Add code comment\n"
            f"- [x] Add markdown comment\n"
            f"- [ ] Close issue\n\n"
            f"> This is a blockquote for testing.\n\n"
            f"Test ID: {random_suffix}"
        )

        {{"issue_title": issue_title, "issue_body": issue_body, "plain_comment": plain_comment, "code_comment": code_comment, "markdown_comment": markdown_comment}}
    input: []
    output:
      - issue_title
      - issue_body
      - plain_comment
      - code_comment
      - markdown_comment
    structured_output: true
    transition: create_issue

  # Step 2: Create the test issue
  - id: create_issue
    type: toolkit
    tool: create_issue
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - issue_title
      - issue_body
    input_mapping:
      title:
        type: variable
        value: issue_title
      body:
        type: variable
        value: issue_body
    output:
      - tool_result
    structured_output: true
    transition: extract_issue_number

  # Step 3: Extract issue number
  - id: extract_issue_number
    type: code
    code:
      type: fixed
      value: |
        import re

        create_result = alita_state.get('tool_result', '')
        issue_number = None

        if isinstance(create_result, str):
            # Look for #123 pattern
            match = re.search(r'#(\d+)', create_result)
            if match:
                issue_number = int(match.group(1))
            # Look for issue/123 pattern
            if not issue_number:
                match = re.search(r'issues?/(\d+)', create_result)
                if match:
                    issue_number = int(match.group(1))
            # Look for "number": 123 pattern
            if not issue_number:
                match = re.search(r'"number":\s*(\d+)', create_result)
                if match:
                    issue_number = int(match.group(1))
        elif isinstance(create_result, dict):
            issue_number = create_result.get('number')

        {"issue_number": issue_number, "validation_results": {"issue_created": issue_number is not None}}
    input:
      - tool_result
    output:
      - issue_number
      - validation_results
    structured_output: true
    transition: list_issues

  # Step 4: List issues to verify our issue appears
  - id: list_issues
    type: toolkit
    tool: get_issues
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input: []
    input_mapping:
      state:
        type: fixed
        value: "open"
    output:
      - issues_list
    structured_output: true
    transition: validate_list_issues

  # Step 5: Validate our issue appears in the list
  - id: validate_list_issues
    type: code
    code:
      type: fixed
      value: |
        import json

        issues_list = alita_state.get('issues_list', '')
        issue_number = alita_state.get('issue_number')
        validation_results = alita_state.get('validation_results', {})

        # Check if our issue appears in the list
        issue_in_list = False
        issues_count = 0

        if issues_list:
            issues_str = str(issues_list)
            if issue_number:
                issue_in_list = str(issue_number) in issues_str

            # Try to count issues
            try:
                if isinstance(issues_list, list):
                    issues_count = len(issues_list)
                elif isinstance(issues_list, str):
                    parsed = json.loads(issues_list)
                    issues_count = len(parsed) if isinstance(parsed, list) else 0
            except:
                pass

        validation_results['issues_listed'] = issues_count > 0
        validation_results['issue_in_list'] = issue_in_list
        validation_results['issues_count'] = issues_count

        {"validation_results": validation_results}
    input:
      - issues_list
      - issue_number
      - validation_results
    output:
      - validation_results
    structured_output: true
    transition: get_issue

  # Step 6: Get specific issue to validate details
  - id: get_issue
    type: toolkit
    tool: get_issue
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - issue_number
    input_mapping:
      issue_number:
        type: variable
        value: issue_number
    output:
      - issue_details
    structured_output: true
    transition: validate_get_issue

  # Step 7: Validate get_issue result
  - id: validate_get_issue
    type: code
    code:
      type: fixed
      value: |
        issue_details = alita_state.get('issue_details', '')
        issue_number = alita_state.get('issue_number')
        issue_title = alita_state.get('issue_title', '')
        validation_results = alita_state.get('validation_results', {})

        # Validate issue details
        issue_retrieved = False
        title_matches = False

        if issue_details and issue_number:
            details_str = str(issue_details)
            issue_retrieved = str(issue_number) in details_str or 'title' in details_str.lower()
            title_matches = issue_title in details_str if issue_title else False

        validation_results['issue_retrieved'] = issue_retrieved
        validation_results['title_matches'] = title_matches

        {"validation_results": validation_results}
    input:
      - issue_details
      - issue_number
      - issue_title
      - validation_results
    output:
      - validation_results
    structured_output: true
    transition: add_plain_comment

  # Step 8: Add plain text comment
  - id: add_plain_comment
    type: toolkit
    tool: comment_on_issue
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - issue_number
      - plain_comment
    input_mapping:
      issue_number:
        type: variable
        value: issue_number
      comment:
        type: variable
        value: plain_comment
    output:
      - tool_result
    structured_output: true
    transition: store_plain_result

  - id: store_plain_result
    type: code
    code:
      type: fixed
      value: |
        result = alita_state.get('tool_result', '')
        validation_results = alita_state.get('validation_results', {})
        validation_results['comment_plain'] = 'success' in str(result).lower() or 'added' in str(result).lower() or 'created' in str(result).lower() or 'http' in str(result).lower()
        {"validation_results": validation_results}
    input:
      - tool_result
      - validation_results
    output:
      - validation_results
    structured_output: true
    transition: add_code_comment

  # Step 9: Add code block comment
  - id: add_code_comment
    type: toolkit
    tool: comment_on_issue
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - issue_number
      - code_comment
    input_mapping:
      issue_number:
        type: variable
        value: issue_number
      comment:
        type: variable
        value: code_comment
    output:
      - tool_result
    structured_output: true
    transition: store_code_result

  - id: store_code_result
    type: code
    code:
      type: fixed
      value: |
        result = alita_state.get('tool_result', '')
        validation_results = alita_state.get('validation_results', {})
        validation_results['comment_code'] = 'success' in str(result).lower() or 'added' in str(result).lower() or 'created' in str(result).lower() or 'http' in str(result).lower()
        {"validation_results": validation_results}
    input:
      - tool_result
      - validation_results
    output:
      - validation_results
    structured_output: true
    transition: add_markdown_comment

  # Step 10: Add markdown comment with table
  - id: add_markdown_comment
    type: toolkit
    tool: comment_on_issue
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - issue_number
      - markdown_comment
    input_mapping:
      issue_number:
        type: variable
        value: issue_number
      comment:
        type: variable
        value: markdown_comment
    output:
      - tool_result
    structured_output: true
    transition: store_markdown_result

  - id: store_markdown_result
    type: code
    code:
      type: fixed
      value: |
        result = alita_state.get('tool_result', '')
        validation_results = alita_state.get('validation_results', {})
        validation_results['comment_markdown'] = 'success' in str(result).lower() or 'added' in str(result).lower() or 'created' in str(result).lower() or 'http' in str(result).lower()
        {"validation_results": validation_results}
    input:
      - tool_result
      - validation_results
    output:
      - validation_results
    structured_output: true
    transition: process_results

  # Step 11: Process and validate all results
  - id: process_results
    type: code
    code:
      type: fixed
      value: |
        issue_number = alita_state.get('issue_number')
        validation_results = alita_state.get('validation_results', {})

        # Check all validations
        issue_created = validation_results.get('issue_created', False)
        issues_listed = validation_results.get('issues_listed', False)
        issue_retrieved = validation_results.get('issue_retrieved', False)
        comment_plain = validation_results.get('comment_plain', False)
        comment_code = validation_results.get('comment_code', False)
        comment_markdown = validation_results.get('comment_markdown', False)

        all_comments_ok = comment_plain and comment_code and comment_markdown
        all_operations_ok = issue_created and issues_listed and issue_retrieved and all_comments_ok

        test_results = {
            "test_passed": all_operations_ok,
            "issue_number": issue_number,
            "operations": {
                "create_issue": issue_created,
                "list_issues": issues_listed,
                "get_issue": issue_retrieved,
                "issues_count": validation_results.get('issues_count', 0)
            },
            "comments": {
                "plain_text": comment_plain,
                "code_block": comment_code,
                "markdown_table": comment_markdown,
                "all_passed": all_comments_ok
            }
        }
        {"test_results": test_results}
    input:
      - issue_number
      - validation_results
    output:
      - test_results
    structured_output: true
    transition: close_issue

  # Step 12: Close the test issue
  - id: close_issue
    type: toolkit
    tool: update_issue
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - issue_number
    input_mapping:
      issue_id:
        type: variable
        value: issue_number
      state:
        type: fixed
        value: "closed"
    output:
      - tool_result
    structured_output: true
    transition: END
