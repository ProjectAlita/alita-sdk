name: "GH04 - Commits Workflow"
description: "Test commit operations: get_commits to retrieve history, then get_commits_diff to compare commits"

toolkits:
  - id: ${GITHUB_TOOLKIT_ID}
    name: ${GITHUB_TOOLKIT_NAME}

state:
  input:
    type: str
  messages:
    type: list
  max_count:
    type: int
    value: 10
  sha:
    type: str
    value: "main"
  tool_result:
    type: str
  commits_list:
    type: list
  base_sha:
    type: str
  head_sha:
    type: str
  diff_result:
    type: str
  validation_results:
    type: dict
  test_results:
    type: dict

entry_point: get_commits

nodes:
  # Step 1: Get commits from main branch
  - id: get_commits
    type: toolkit
    tool: get_commits
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - max_count
      - sha
    input_mapping:
      max_count:
        type: variable
        value: max_count
      sha:
        type: variable
        value: sha
    output:
      - tool_result
    structured_output: true
    transition: validate_commits

  # Step 2: Validate commits and extract SHAs for diff
  - id: validate_commits
    type: code
    code:
      type: fixed
      value: |
        import json

        commits_result = alita_state.get('tool_result')
        max_count = alita_state.get('max_count', 10)

        commits_list = []
        error_message = None

        try:
            if isinstance(commits_result, list):
                commits_list = commits_result
            elif isinstance(commits_result, str):
                try:
                    commits_list = json.loads(commits_result)
                except:
                    pass
        except Exception as e:
            error_message = str(e)

        # Validate commits structure
        has_commits = len(commits_list) > 0 if isinstance(commits_list, list) else False
        within_limit = len(commits_list) <= max_count if isinstance(commits_list, list) else False
        commits_have_sha = all('sha' in c for c in commits_list) if commits_list else False

        # Extract first and last commit SHAs for diff comparison
        base_sha = None
        head_sha = None
        if commits_list and len(commits_list) >= 2:
            # Use oldest and newest commits from the list
            head_sha = commits_list[0].get('sha') if isinstance(commits_list[0], dict) else None
            base_sha = commits_list[-1].get('sha') if isinstance(commits_list[-1], dict) else None
        elif commits_list and len(commits_list) == 1:
            # Only one commit, use main as base
            head_sha = commits_list[0].get('sha') if isinstance(commits_list[0], dict) else None
            base_sha = "main"

        # Build sample for output
        commits_sample = []
        for commit in commits_list[:5]:
            if isinstance(commit, dict):
                commits_sample.append({
                    "sha": commit.get('sha', '')[:8] if commit.get('sha') else None,
                    "author": commit.get('author'),
                    "message": (commit.get('message', '') or '')[:50]
                })

        validation_results = {
            "get_commits_ok": has_commits and within_limit,
            "commits_count": len(commits_list) if isinstance(commits_list, list) else 0,
            "within_limit": within_limit,
            "has_sha_field": commits_have_sha,
            "commits_sample": commits_sample
        }

        {"commits_list": commits_list, "base_sha": base_sha, "head_sha": head_sha, "validation_results": validation_results}
    input:
      - tool_result
      - max_count
    output:
      - commits_list
      - base_sha
      - head_sha
      - validation_results
    structured_output: true
    transition: get_commits_diff

  # Step 3: Get diff between two commits
  - id: get_commits_diff
    type: toolkit
    tool: get_commits_diff
    toolkit_name: ${GITHUB_TOOLKIT_NAME}
    input:
      - base_sha
      - head_sha
    input_mapping:
      base_sha:
        type: variable
        value: base_sha
      head_sha:
        type: variable
        value: head_sha
    output:
      - diff_result
    structured_output: true
    transition: process_results

  # Step 4: Process and validate all results
  - id: process_results
    type: code
    code:
      type: fixed
      value: |
        import json

        diff_result = alita_state.get('diff_result')
        base_sha = alita_state.get('base_sha')
        head_sha = alita_state.get('head_sha')
        validation_results = alita_state.get('validation_results', {})

        # Parse diff result
        diff_data = {}
        try:
            if isinstance(diff_result, dict):
                diff_data = diff_result
            elif isinstance(diff_result, str):
                try:
                    diff_data = json.loads(diff_result)
                except:
                    diff_data = {'raw': diff_result}
        except:
            pass

        # Validate diff result - check for expected fields or meaningful content
        diff_executed = diff_result is not None
        has_status = 'status' in diff_data
        has_files = 'files' in diff_data
        has_commits_info = 'commit' in str(diff_data).lower() or 'ahead' in str(diff_data).lower()

        diff_valid = diff_executed and (has_status or has_files or has_commits_info)

        # Get summary info
        files_count = len(diff_data.get('files', [])) if isinstance(diff_data.get('files'), list) else 0

        validation_results['get_commits_diff_ok'] = diff_valid
        validation_results['diff_has_status'] = has_status
        validation_results['diff_has_files'] = has_files
        validation_results['diff_files_count'] = files_count

        # Overall test pass
        get_commits_ok = validation_results.get('get_commits_ok', False)
        all_ok = get_commits_ok and diff_valid

        test_results = {
            "test_passed": all_ok,
            "operations": {
                "get_commits": get_commits_ok,
                "get_commits_diff": diff_valid
            },
            "details": {
                "commits_count": validation_results.get('commits_count', 0),
                "base_sha": base_sha[:8] if base_sha and len(base_sha) > 8 else base_sha,
                "head_sha": head_sha[:8] if head_sha and len(head_sha) > 8 else head_sha,
                "diff_files_count": files_count,
                "commits_sample": validation_results.get('commits_sample', [])
            }
        }
        {"test_results": test_results}
    input:
      - diff_result
      - base_sha
      - head_sha
      - validation_results
    output:
      - test_results
    structured_output: true
    transition: END
