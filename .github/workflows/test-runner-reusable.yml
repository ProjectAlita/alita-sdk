name: Test Runner Reusable
run-name: Executing test for ${{ inputs.test_cases_dir }}

on:
  workflow_call:
    inputs:
      test_cases_dir:
        description: 'Test cases directory (e.g., github, ado, confluence)'
        required: true
        type: string
      environment:
        description: 'Environment to run tests in (local or other)'
        required: false
        type: string
        default: 'local'
  workflow_dispatch:
    inputs:
      test_cases_dir:
        description: 'Test cases directory (e.g., github, ado, confluence)'
        required: true
        type: string
      environment:
        description: 'Environment to run tests in (local or other)'
        required: false
        type: string
        default: 'local'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test-execution:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image
        run: |
          IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          docker pull ${{ env.REGISTRY }}/$IMAGE_NAME:pyodide

      - name: Calculate and run test command
        run: |
          if [ "${{ inputs.environment }}" = "local" ]; then
            TEST_COMMAND="/app/.alita/tests/test_pipelines/run_all_suites.sh --local --show-output  suites/${{ inputs.test_cases_dir }}"
          else
            TEST_COMMAND="/app/.alita/tests/test_pipelines/run_all_suites.sh --show-output  suites/${{ inputs.test_cases_dir }}"
          fi

          echo "DOCKER_COMMAND_COMPOSED=$TEST_COMMAND" >> $GITHUB_ENV  
          
          echo "Running test command: $TEST_COMMAND"         

      - name: Run docker-compose
        run: |
          export GIT_TOOL_ACCESS_TOKEN="${{ secrets.GIT_TOOL_ACCESS_TOKEN }}"
          export DEPLOYMENT_URL="${{ secrets.DEPLOYMENT_URL }}"
          export ALITA_API_KEY="${{ secrets.ALITA_API_KEY }}"
          export PROJECT_ID="${{ secrets.PROJECT_ID }}"
          export CONFLUENCE_API_KEY="${{ secrets.CONFLUENCE_API_KEY }}"
          export CONFLUENCE_BASE_URL="${{ secrets.CONFLUENCE_BASE_URL }}"
          export CONFLUENCE_USERNAME="${{ secrets.CONFLUENCE_USERNAME }}"
          export ADO_TOKEN="${{ secrets.ADO_TOKEN }}"
          export ADO_REPOSITORY_ID="${{ secrets.ADO_REPOSITORY_ID }}"
          export ADO_ORGANIZATION_URL="${{ secrets.ADO_ORGANIZATION_URL }}"
          export ADO_PROJECT="${{ secrets.ADO_PROJECT }}"
          export TEST_CASES_DIR="${{ inputs.test_cases_dir}}"
          export ENVIRONMENT="${{ inputs.environment }}"
          export DOCKER_COMMAND="${{ env.DOCKER_COMMAND_COMPOSED }}"
          export ENV_NAME="${{ inputs.environment }}"
          docker-compose up -d

      - name: Wait for tests to complete
        run: |
          echo "Waiting for test execution to complete..."
          
          TIMEOUT=10000
          ELAPSED=0
          INTERVAL=20
          CONTAINER_EXIT_CODE=0
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            STATUS=$(docker inspect alita-sdk-dev --format='{{.State.Status}}' 2>/dev/null || echo "not-found")
            
            if [ "$STATUS" = "exited" ]; then
              EXIT_CODE=$(docker inspect alita-sdk-dev --format='{{.State.ExitCode}}')
              CONTAINER_EXIT_CODE=$EXIT_CODE
              echo "Container exited with code: $EXIT_CODE"
              
              if [ "$EXIT_CODE" -eq 0 ]; then
                echo "✅ Container completed successfully"
              else
                echo "❌ Container exited with error code $EXIT_CODE"
              fi
              
              echo "Container logs:"
              docker-compose logs alita-sdk
              break
            elif [ "$STATUS" = "running" ]; then
              echo "Container still running... ($ELAPSED seconds elapsed)"
              echo "::group:: Current logs"
              docker-compose logs alita-sdk --tail=50
              echo "::endgroup::"
            else
              echo "Container status: $STATUS"
            fi
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "⚠️ Timeout reached after $TIMEOUT seconds"
            docker-compose logs alita-sdk
            exit 1
          fi
          
          if [ $CONTAINER_EXIT_CODE -ne 0 ]; then
            echo "::error::Tests failed with exit code $CONTAINER_EXIT_CODE"
            exit $CONTAINER_EXIT_CODE
          fi

      - name: Copy test results
        if: always()
        run: |
          docker cp alita-sdk-dev:/app/.alita/tests/test_pipelines/test_results/suites/${{ inputs.test_cases_dir }}/results.json ./results.json || echo "{}" > ./results.json
          
      - name: Generate test report
        if: always()
        run: |
          echo "Generating test report..."
          python .alita/tests/test_pipelines/scripts/generate_report.py ./results.json

      - name: LS
        if: always()
        run: |
          ls -la
      
      - name: Save Docker logs
        if: always()
        run: |
          docker-compose logs alita-sdk > docker-logs.txt 2>&1 || echo "Failed to retrieve logs" > docker-logs.txt
          
      - name: Stop docker-compose
        if: always()
        run: docker-compose down --remove-orphans

      - name: Upload test results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ inputs.test_cases_dir }}
          path: |
            ./results.html
            ./docker-logs.txt
          retention-days: 1

      - name: CLEAN UP WORKSPACE AFTER RUN
        if: always()
        run: |
          sudo rm -rf $GITHUB_WORKSPACE/{,.[!.],..?}*
