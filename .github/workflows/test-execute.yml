name: Execute toolkit AI tests

on:
  pull_request:
     types: [opened, synchronize]
     branches:
       - main
  workflow_dispatch:

jobs:
  configure-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has-tests: ${{ steps.set-matrix.outputs.has-tests }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate test matrix
        id: set-matrix
        run: |
          # Generate test directories from testcases folder
          TEST_DIRS=$(find .github/ai_native/testcases -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "Available test directories: $TEST_DIRS"
          
          # Calculate diffs from PR if available
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            echo "Fetching changed files from PR #${{ github.event.pull_request.number }}"
            
            # Fetch the changed files from the PR
            CHANGED_FILES_RAW=$(gh pr diff ${{ github.event.pull_request.number }} --name-only)
            echo "Raw changed files:"
            echo "$CHANGED_FILES_RAW"
            
            CHANGED_FILES=$(echo "$CHANGED_FILES_RAW" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "Changed files from PR (JSON): $CHANGED_FILES"
            
            # Check if pyproject.toml or alita_sdk/runtime was changed (using grep as well for robustness)
            if echo "$CHANGED_FILES_RAW" | grep -q "^pyproject\.toml$" || \
               echo "$CHANGED_FILES_RAW" | grep -q "^alita_sdk/runtime/" || \
               echo "$CHANGED_FILES" | jq -e 'any(. == "pyproject.toml" or startswith("alita_sdk/runtime/"))' > /dev/null; then
              echo "::notice::pyproject.toml or alita_sdk/runtime was changed, running all tests"
              echo "matrix=$TEST_DIRS" >> $GITHUB_OUTPUT
              echo "has-tests=true" >> $GITHUB_OUTPUT
              echo "::notice::Generated matrix: $TEST_DIRS"
            else
              # Filter for alita_sdk/tools/* paths and extract toolkit names
              CHANGED_TOOLKITS=$(echo "$CHANGED_FILES" | jq -c '[.[] | select(startswith("alita_sdk/tools/")) | split("/")[2]] | unique')
              echo "Changed toolkits: $CHANGED_TOOLKITS"
              
              # Filter changed toolkits to only include those present in TEST_DIRS
              FILTERED=$(jq -n -c --argjson test_dirs "$TEST_DIRS" --argjson changed "$CHANGED_TOOLKITS" \
                '$changed | map(select(. as $item | $test_dirs | index($item)))')
              
              # Check if we got any matching test cases
              if [ "$(echo "$FILTERED" | jq 'length')" -gt 0 ]; then
                echo "matrix=$FILTERED" >> $GITHUB_OUTPUT
                echo "has-tests=true" >> $GITHUB_OUTPUT
                echo "::notice::Generated matrix from PR diff: $FILTERED"
              else
                echo "::error::No test cases found for the changed toolkits"
                echo "Changed toolkits: $CHANGED_TOOLKITS"
                echo "has-tests=false" >> $GITHUB_OUTPUT
              fi
            fi
          else
            echo "matrix=$TEST_DIRS" >> $GITHUB_OUTPUT
            echo "has-tests=true" >> $GITHUB_OUTPUT
            echo "::notice::Generated matrix: $TEST_DIRS"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  test-execution:
    needs: configure-matrix
    if: needs.configure-matrix.outputs.has-tests == 'true'
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        test_cases_dir: ${{ fromJson(needs.configure-matrix.outputs.matrix) }}
    uses: ./.github/workflows/test-runner-reusable.yml
    with:
      test_cases_dir: ${{ matrix.test_cases_dir }}
    secrets: inherit